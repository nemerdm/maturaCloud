<!DOCTYPE html>
<html lang="pl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matura Cloud Ultimate v9.6.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', card: '#1e293b', text: '#f8fafc', subtext: '#94a3b8', border: '#334155' }
                    }
                }
            }
        }
    </script>

    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .serif { font-family: 'Merriweather', serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background-color: #475569; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Animacje */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .pop-up { animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .card-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .correct-anim { animation: pulseGreen 0.4s; }
        .wrong-anim { animation: shake 0.3s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .fade-out { animation: fadeOut 0.3s forwards; }
        @keyframes fadeOut { to { opacity: 0; transform: scale(0.9); } }
        .pop-in { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Fiszki 3D */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        /* Grammar Blocks - SVO */
        .g-block { padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; display: inline-block; margin-right: 4px; margin-bottom: 4px; }
        .gb-subject { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .gb-verb { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .gb-object { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .gb-extra { background-color: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }
        .gb-op { background-color: #fff7ed; color: #9a3412; border: 1px solid #ffedd5; }
        
        .dark .gb-subject { background-color: #1e3a8a; color: #dbeafe; border-color: #172554; }
        .dark .gb-verb { background-color: #7f1d1d; color: #fee2e2; border-color: #450a0a; }
        .dark .gb-object { background-color: #064e3b; color: #d1fae5; border-color: #022c22; }

        .dash-card:hover { transform: translateY(-2px); transition: transform 0.2s; }
        .wave-bar { width: 6px; background-color: #6366f1; border-radius: 99px; animation: wave 1s ease-in-out infinite; }
        @keyframes wave { 0%, 100% { height: 10px; } 50% { height: 40px; } }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .match-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-dark-bg dark:text-dark-text h-[100dvh] flex flex-col overflow-hidden transition-colors duration-300">

    <!-- GLOBAL HEADER -->
    <header class="bg-white dark:bg-dark-card shadow-sm z-30 flex-none border-b border-slate-200 dark:border-dark-border">
        <div class="w-full px-4 py-3 flex justify-between items-center">
            <div onclick="goHome()" class="cursor-pointer flex items-center gap-3">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-md">M</div>
                <div>
                    <h1 class="text-sm font-bold text-slate-900 dark:text-white tracking-tight leading-none">Matura<span class="text-indigo-600 dark:text-indigo-400">Cloud</span></h1>
                    <p class="text-[10px] text-slate-400 font-medium uppercase tracking-wider mt-0.5">Ultimate v9.6.4</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-1 bg-orange-50 dark:bg-orange-900/20 px-2 py-1 rounded-full border border-orange-100 dark:border-orange-800/30">
                    <span class="text-sm">üî•</span>
                    <span class="text-xs font-bold text-orange-600 dark:text-orange-400" id="stat-streak">1</span>
                </div>
                <button onclick="toggleDarkMode()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-300">
                    <span id="theme-icon">üåô</span>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-hidden relative w-full h-full">
        
        <!-- DASHBOARD -->
        <div id="view-home" class="absolute inset-0 z-20 bg-slate-50 dark:bg-dark-bg p-4 md:p-8 overflow-y-auto">
            <div class="max-w-5xl mx-auto pb-20 text-slate-800 dark:text-white">
                <div class="mb-8 flex justify-between items-end">
                    <div>
                        <h2 class="text-2xl font-bold">Witaj, <span id="display-user-name">Adepcie</span>! üëã</h2>
                        <p class="text-slate-500 dark:text-dark-subtext">Tw√≥j system przygotowa≈Ñ maturalnych.</p>
                    </div>
                    <button onclick="resetAllData()" class="text-[10px] text-slate-300 hover:text-red-400 underline">Resetuj Postƒôp</button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white dark:bg-dark-card p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border text-center">
                        <p class="text-xs text-slate-400 uppercase font-bold mb-1">Globalna ≈örednia</p>
                        <p class="text-2xl font-black text-indigo-600 dark:text-indigo-400" id="stat-avg">0%</p>
                    </div>
                    <div class="col-span-2 bg-gradient-to-r from-slate-800 to-indigo-900 p-4 rounded-2xl shadow-lg text-white flex justify-between items-center relative overflow-hidden">
                        <div class="relative z-10">
                            <p class="font-bold text-lg">Tw√≥j Cel: Matura 2026</p>
                            <p class="text-xs text-slate-300">Konsekwencja to klucz do 100%.</p>
                        </div>
                        <div class="text-6xl opacity-10 absolute -right-2 -bottom-2">üìä</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="content-grid"></div>
            </div>
        </div>

        <!-- SUBJECT HUB -->
        <div id="view-subject-hub" class="absolute inset-0 z-40 bg-slate-50 dark:bg-dark-bg hidden overflow-y-auto">
            <div class="max-w-md mx-auto min-h-full flex flex-col p-6 pb-24">
                <div class="flex justify-between items-center mb-8">
                    <button onclick="goHome()" class="w-10 h-10 rounded-full bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border flex items-center justify-center text-slate-500">‚Üê</button>
                    <span class="text-xs font-bold uppercase tracking-widest text-slate-400">Centrum Przedmiotu</span>
                </div>
                
                <div class="text-center mb-8">
                    <div id="hub-icon" class="text-7xl mb-4 inline-block">üìê</div>
                    <h2 id="hub-title" class="text-3xl font-black text-slate-800 dark:text-white mb-2">Przedmiot</h2>
                    <p id="hub-desc" class="text-slate-500 dark:text-slate-400 italic">Wybierz modu≈Ç nauki</p>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-8 text-slate-800 dark:text-white">
                    <div class="bg-white dark:bg-dark-card p-4 rounded-2xl border border-slate-100 dark:border-dark-border shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">≈örednia</p>
                        <p id="hub-score" class="text-2xl font-black text-indigo-600">0%</p>
                    </div>
                    <div class="bg-white dark:bg-dark-card p-4 rounded-2xl border border-slate-100 dark:border-dark-border shadow-sm text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Sesje</p>
                        <p id="hub-count" class="text-2xl font-black">0</p>
                    </div>
                </div>

                <div id="hub-features-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- WRITTEN SHEET VIEW -->
        <div id="view-sheet" class="fixed inset-0 z-50 bg-white dark:bg-dark-bg hidden flex flex-col h-[100dvh]">
            <div class="flex-none border-b border-slate-200 dark:border-dark-border px-4 py-3 flex justify-between items-center bg-white dark:bg-dark-card">
                <button onclick="backToHub()" class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 dark:text-slate-300 flex items-center justify-center">‚úï</button>
                <span id="sheet-title" class="font-bold truncate max-w-[150px] text-slate-800 dark:text-white text-sm">Arkusz</span>
                <span id="timer" class="font-mono bg-slate-100 dark:bg-slate-700 dark:text-slate-300 px-2 py-1 rounded text-xs">00:00</span>
            </div>
            <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                <div class="h-[35%] md:h-full md:w-1/2 p-6 overflow-y-auto border-b md:border-b-0 md:border-r border-slate-200 dark:border-dark-border">
                    <div id="source-content" class="prose prose-sm dark:prose-invert text-slate-700 dark:text-slate-300"></div>
                </div>
                <div class="flex-1 p-4 md:p-8 overflow-y-auto bg-slate-50 dark:bg-dark-card">
                    <div id="questions-list" class="space-y-6"></div>
                </div>
            </div>
            <div class="p-4 bg-white dark:bg-dark-card border-t border-slate-200 dark:border-dark-border">
                <button onclick="finishSheet()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg">Zako≈Ñcz Arkusz ‚ûú</button>
            </div>
        </div>

        <!-- ORAL SIMULATOR VIEW -->
        <div id="view-oral" class="absolute inset-0 z-50 bg-white dark:bg-dark-bg hidden flex flex-col items-center justify-center p-6 overflow-y-auto">
            <div class="max-w-md w-full min-h-full flex flex-col justify-center">
                <div id="oral-phase-1">
                    <span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">Matura Ustna</span>
                    <h2 class="text-2xl font-bold mt-4 mb-2 text-slate-800 dark:text-white">Nagrywanie</h2>
                    <div class="bg-slate-50 dark:bg-dark-card p-6 rounded-2xl border border-slate-200 dark:border-dark-border mb-8 shadow-sm text-left">
                        <p id="oral-question-text" class="text-lg font-serif italic text-slate-700 dark:text-slate-300">≈Åadowanie pytania...</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <button onclick="toggleRecording()" id="mic-btn" class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center text-3xl shadow-xl text-white mb-4 active:scale-95 transition-transform">üéôÔ∏è</button>
                        <p id="rec-status" class="text-slate-400 text-sm font-mono mb-2">Kliknij mikrofon</p>
                        <p id="rec-timer" class="text-4xl font-black text-slate-800 dark:text-white hidden">00:00</p>
                        <div id="wave-container" class="hidden flex gap-1 h-10 items-center justify-center">
                            <div class="wave-bar" style="animation-delay:0s"></div>
                            <div class="wave-bar" style="animation-delay:0.1s"></div>
                            <div class="wave-bar" style="animation-delay:0.2s"></div>
                        </div>
                    </div>
                </div>
                <div id="oral-phase-2" class="hidden text-center"><div class="text-6xl mb-4 animate-bounce">ü§ñ</div><h3 class="text-xl font-bold dark:text-white">Analizowanie...</h3></div>
                <div id="oral-phase-3" class="hidden text-left pop-up pb-10">
                    <h3 class="text-xl font-bold mb-4 dark:text-white">Klucz Egzaminacyjny</h3>
                    <div id="oral-checklist" class="space-y-2 mb-6"></div>
                    <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 text-center">
                        <p id="oral-score-display" class="text-4xl font-black text-indigo-700 dark:text-indigo-300">0%</p>
                    </div>
                    <button onclick="finishOral()" class="w-full mt-6 bg-slate-900 dark:bg-indigo-600 text-white py-4 rounded-xl font-bold">Zapisz i zako≈Ñcz</button>
                </div>
                <button onclick="backToHub()" class="mt-8 text-slate-400 text-sm hover:underline">Anuluj</button>
            </div>
        </div>

        <!-- ENGLISH APP VIEW -->
        <div id="view-english-app" class="absolute inset-0 z-50 bg-slate-50 dark:bg-dark-bg hidden flex flex-col h-[100dvh]">
             <div class="bg-white dark:bg-dark-card shadow-sm z-20 flex-none border-b border-slate-100 dark:border-dark-border px-4 py-3 flex justify-between items-center">
                <button onclick="backToHub()" class="text-xs text-slate-400 hover:text-indigo-500 transition-colors">‚Üê Wr√≥ƒá</button>
                <h1 class="text-sm font-bold text-indigo-600" id="eng-header-title">English Prep</h1>
                <div class="w-8"></div>
            </div>
            
            <div class="flex-1 overflow-hidden relative w-full max-w-md mx-auto">
                
                <!-- 1. QUIZ -->
                <div id="eng-view-quiz" class="absolute inset-0 overflow-y-auto p-4 flex flex-col pb-24 transition-opacity hidden opacity-0">
                    <div id="eng-start-screen" class="w-full text-center mt-4">
                        <div class="bg-white dark:bg-dark-card p-6 rounded-2xl border border-slate-100 dark:border-dark-border mb-6 shadow-sm">
                            <div class="text-5xl mb-4">üìù</div>
                            <h2 class="text-xl font-bold dark:text-white mb-2">Trening Maturalny</h2>
                            <p class="text-slate-500 mb-6 text-sm">RozwiƒÖ≈º testy A/B/C. System zapamiƒôtuje b≈Çƒôdy.</p>
                            
                            <div id="eng-resume-section" class="hidden mb-4">
                                <button onclick="EnglishApp.resumeQuiz()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-xl font-semibold shadow-lg shadow-indigo-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                                    <span>‚ñ∂Ô∏è</span> Wzn√≥w sesjƒô
                                </button>
                            </div>
                            
                            <button onclick="EnglishApp.startNewQuiz()" class="w-full bg-slate-900 dark:bg-slate-700 text-white py-3.5 rounded-xl font-semibold hover:bg-slate-800 active:scale-95 transition-all mb-3">Nowy Test</button>
                            
                            <div id="eng-error-review-section" class="hidden mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                                <p class="text-sm text-red-500 font-medium mb-2">B≈Çƒôdy do poprawy: <span id="eng-error-count">0</span></p>
                                <button onclick="EnglishApp.startErrorReview()" class="w-full bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border border-red-100 dark:border-red-800 py-3 rounded-xl font-semibold hover:bg-red-100 active:scale-95 transition-all">üíä Popraw b≈Çƒôdy</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="eng-quiz-container" class="w-full hidden">
                        <div class="bg-white dark:bg-dark-card p-6 rounded-2xl border border-slate-100 dark:border-dark-border mb-4 card-enter shadow-sm">
                            <div class="flex justify-between items-center mb-4 text-[10px] font-bold text-slate-400">
                                <span id="eng-category-tag" class="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-2.5 py-1 rounded-full uppercase">KATEGORIA</span>
                                <span id="eng-q-counter" class="font-mono">1/1</span>
                            </div>
                            <h3 id="eng-question-text" class="text-lg font-medium leading-snug dark:text-white mb-4">...</h3>
                            
                            <div id="eng-context-box" class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border-l-4 border-indigo-400 mb-5 hidden">
                                <p id="eng-context-text" class="text-sm text-slate-600 dark:text-slate-300 italic"></p>
                            </div>
                            
                            <div id="eng-options-container" class="space-y-2.5"></div>
                        </div>
                        <div id="eng-explanation-card" class="hidden bg-slate-800 text-white p-5 rounded-xl mt-2 mb-6 card-enter">
                            <p id="eng-explanation-text" class="text-sm text-slate-300 leading-relaxed"></p>
                            <button onclick="EnglishApp.nextQuestion()" class="mt-4 w-full bg-white text-slate-900 py-3 rounded-lg font-bold">Dalej ‚Üí</button>
                        </div>
                    </div>
                    <div id="eng-results-screen" class="w-full hidden text-center mt-8">
                        <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border">
                            <h2 class="text-2xl font-bold dark:text-white mb-2">Wynik sesji</h2>
                            <span class="text-6xl font-black text-indigo-600" id="eng-final-score">0</span>
                            <button onclick="EnglishApp.startNewQuiz()" class="w-full mt-6 bg-indigo-600 text-white py-3.5 rounded-xl font-semibold active:scale-95 transition-all mb-3 shadow-lg">Graj ponownie</button>
                            <button onclick="EnglishApp.showQuizStart()" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 py-3.5 rounded-xl font-semibold hover:bg-slate-200 dark:hover:bg-slate-600 transition-all">Wr√≥ƒá do menu</button>
                        </div>
                    </div>
                </div>

                <!-- 2. SCRAMBLE -->
                <div id="eng-view-scramble" class="absolute inset-0 overflow-y-auto p-4 flex flex-col pb-24 transition-opacity hidden opacity-0">
                    <div id="eng-scramble-start" class="text-center mt-4">
                        <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border">
                            <div class="text-5xl mb-4">üß©</div>
                            <h2 class="text-xl font-bold dark:text-white mb-2">Uk≈Çadanka Zda≈Ñ</h2>
                            <button onclick="EnglishApp.startScramble()" class="w-full bg-purple-600 text-white py-3.5 rounded-xl font-semibold shadow-lg active:scale-95 transition-all mt-4">Graj</button>
                        </div>
                    </div>
                    <div id="eng-scramble-game" class="hidden w-full h-full flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xs font-bold text-slate-400 uppercase">Gramatyka</span>
                            <span id="eng-scramble-counter" class="text-xs font-mono text-purple-600 font-bold">1/1</span>
                        </div>
                        <div class="bg-white dark:bg-dark-card p-4 rounded-xl border border-slate-100 dark:border-dark-border min-h-[120px] mb-4 flex flex-wrap gap-2 content-start transition-colors shadow-sm" id="eng-scramble-dropzone"></div>
                        <p id="eng-scramble-translation" class="text-sm text-slate-400 italic text-center mb-6">...</p>
                        <div id="eng-scramble-bank" class="flex flex-wrap gap-2 justify-center"></div>
                        <div class="mt-auto pb-4">
                            <button onclick="EnglishApp.checkScramble()" id="eng-scramble-check-btn" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg">Sprawd≈∫</button>
                            <div id="eng-scramble-feedback" class="hidden mt-4 text-center p-3 rounded-lg font-bold"></div>
                            <button onclick="EnglishApp.nextScramble()" id="eng-scramble-next-btn" class="hidden w-full mt-4 bg-purple-600 text-white py-4 rounded-xl font-bold shadow-lg">Kolejne zdanie</button>
                        </div>
                    </div>
                </div>

                <!-- 3. MEMORY -->
                <div id="eng-view-memory" class="absolute inset-0 overflow-y-auto p-4 flex flex-col pb-24 transition-opacity hidden opacity-0">
                    <div id="eng-memory-start" class="text-center mt-4">
                        <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border mb-6">
                            <div class="text-5xl mb-4">‚ö°</div>
                            <h2 class="text-xl font-bold dark:text-white mb-2">Szybkie Pary</h2>
                            <p class="text-sm text-slate-500 mb-4">Po≈ÇƒÖcz angielskie s≈Ç√≥wka z ich t≈Çumaczeniami najszybciej jak potrafisz.</p>
                            <button onclick="EnglishApp.startMemory()" class="w-full bg-pink-500 text-white py-3.5 rounded-xl font-semibold shadow-lg active:scale-95 transition-all">Start</button>
                        </div>
                    </div>
                    <div id="eng-memory-game" class="hidden w-full">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xs font-bold text-slate-400 uppercase">Pozosta≈Ço: <span id="eng-memory-score" class="text-pink-600 font-bold">6</span> par</span>
                            <button onclick="EnglishApp.showMemoryStart()" class="text-xs text-slate-400 underline">Zako≈Ñcz</button>
                        </div>
                        <div id="eng-memory-grid" class="match-grid pb-20 mt-4"></div>
                        <div id="eng-memory-win" class="hidden fixed inset-0 flex items-center justify-center bg-black/50 z-50 p-4">
                            <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-xl text-center max-w-sm w-full pop-in">
                                <h3 class="text-2xl font-bold dark:text-white mb-4">B≈Çyskawica! üöÄ</h3>
                                <button onclick="EnglishApp.startMemory()" class="w-full py-3 bg-pink-600 text-white rounded-xl font-bold shadow-lg mb-3">Jeszcze raz</button>
                                <button onclick="EnglishApp.showMemoryStart()" class="w-full py-3 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-xl font-bold">Wr√≥ƒá do menu</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. FLASHCARDS -->
                <div id="eng-view-flashcards" class="absolute inset-0 overflow-y-auto p-4 pb-24 hidden opacity-0 transition-opacity flex flex-col items-center">
                    <div id="eng-flash-start" class="w-full text-center mt-4">
                        <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border mb-6">
                            <div class="text-5xl mb-4">üß†</div>
                            <h2 class="text-xl font-bold mb-2 dark:text-white">Fiszki</h2>
                            
                            <p class="text-slate-500 mb-6 text-sm">Masz <span id="eng-flash-total-count" class="font-bold text-indigo-600 dark:text-indigo-400">0</span> s≈Ç√≥wek. Umiesz: <span id="eng-flash-known-count" class="font-bold text-green-600">0</span>.</p>
                            
                            <button onclick="EnglishApp.startFlashcards()" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-semibold shadow-lg active:scale-95 transition-all">Ucz siƒô</button>
                            <button onclick="EnglishApp.resetFlashcards()" class="mt-4 text-xs text-slate-400 underline hover:text-slate-500 transition-colors">Zresetuj postƒôp fiszek</button>
                        </div>
                    </div>
                    <div id="eng-flash-game" class="w-full hidden flex flex-col h-full max-h-[600px] mt-4">
                        <div class="flex justify-between items-center mb-4 px-2">
                            <span class="text-xs font-bold text-slate-400">SESJA</span>
                            <span id="eng-flash-counter" class="text-xs font-mono text-indigo-600 font-bold">1/10</span>
                        </div>
                        <div class="relative w-full h-64 perspective-1000 mb-6 cursor-pointer group" onclick="EnglishApp.flipCard()">
                            <div id="eng-flash-inner" class="relative w-full h-full text-center transition-transform duration-500 transform-style-3d shadow-xl rounded-2xl">
                                <div class="absolute w-full h-full bg-white dark:bg-dark-card border-2 border-slate-100 dark:border-dark-border rounded-2xl backface-hidden flex flex-col items-center justify-center p-6 text-slate-800 dark:text-white">
                                    <span class="text-xs text-slate-400 uppercase mb-2">English</span>
                                    <h3 id="eng-flash-front" class="text-2xl font-bold leading-tight">...</h3>
                                    <div class="mt-4 text-slate-300 text-xs">(Dotknij, aby obr√≥ciƒá)</div>
                                </div>
                                <div class="absolute w-full h-full bg-indigo-600 text-white rounded-2xl backface-hidden rotate-y-180 flex flex-col items-center justify-center p-6 text-center">
                                    <span class="text-xs text-indigo-200 uppercase mb-2">Polski</span>
                                    <h3 id="eng-flash-back" class="text-2xl font-bold mb-3 leading-tight">...</h3>
                                    <p id="eng-flash-example" class="text-sm text-indigo-100 italic">"..."</p>
                                    <button onclick="event.stopPropagation(); EnglishApp.speak(document.getElementById('eng-flash-front').innerText)" class="mt-4 p-2 bg-indigo-500 rounded-full hover:bg-indigo-400 transition-colors">üîä</button>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-auto">
                            <button onclick="EnglishApp.rateFlashcard(false)" class="py-4 bg-red-100 text-red-700 rounded-xl font-bold active:scale-95 transition-transform shadow-sm">Powt√≥rka üò¨</button>
                            <button onclick="EnglishApp.rateFlashcard(true)" class="py-4 bg-green-100 text-green-700 rounded-xl font-bold active:scale-95 transition-transform shadow-sm">Znam to üòé</button>
                        </div>
                    </div>
                    <div id="eng-flash-done" class="hidden w-full text-center mt-10">
                         <div class="bg-white dark:bg-dark-card p-8 rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border">
                            <div class="text-5xl mb-4">üåü</div>
                            <h2 class="text-2xl text-slate-800 dark:text-white font-bold mb-2">Koniec sesji!</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Baza na ten moment przerobiona.</p>
                            <button onclick="EnglishApp.startFlashcards()" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-semibold shadow-lg active:scale-95 transition-all mb-3">Ucz siƒô dalej</button>
                            <button onclick="EnglishApp.showFlashcardStart()" class="w-full bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 py-3.5 rounded-xl font-semibold hover:bg-slate-200 dark:hover:bg-slate-700 transition-all mb-4">Wr√≥ƒá do menu fiszek</button>
                            <button onclick="EnglishApp.resetFlashcards()" class="text-xs text-slate-400 underline hover:text-slate-500 transition-colors">Zresetuj postƒôp fiszek</button>
                         </div>
                    </div>
                </div>

                <!-- 5. VOCAB & GRAMMAR -->
                <div id="eng-view-vocab" class="absolute inset-0 overflow-y-auto p-4 pb-24 hidden opacity-0 transition-opacity">
                    <div class="sticky top-0 bg-slate-50 dark:bg-dark-bg pt-2 pb-4 z-10">
                        <div class="relative">
                            <input type="text" id="eng-vocab-search" placeholder="Szukaj s≈Ç√≥wka..." onkeyup="EnglishApp.filterVocab()" class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 dark:bg-dark-card dark:text-white outline-none text-sm transition-all shadow-sm">
                            <span class="absolute left-3 top-3 text-slate-400">üîç</span>
                        </div>
                    </div>
                    <div id="eng-vocab-list" class="space-y-3"></div>
                </div>
                
                <div id="eng-view-grammar" class="absolute inset-0 overflow-y-auto p-4 pb-24 hidden opacity-0 transition-opacity">
                    <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border mb-6 text-center">
                        <div class="text-5xl mb-4">üìö</div>
                        <h2 class="text-xl font-bold mb-2 text-slate-800 dark:text-white">Gramatyka w Pigu≈Çce</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Zrozum logikƒô, a przestaniesz "strzelaƒá".</p>
                        <div class="mt-4 flex flex-wrap justify-center gap-2 text-[10px] uppercase font-bold text-slate-400">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded dark:bg-blue-900/50 dark:text-blue-300 border border-blue-200 dark:border-blue-800">Podmiot</span>
                            <span class="px-2 py-1 bg-red-100 text-red-700 rounded dark:bg-red-900/50 dark:text-red-300 border border-red-200 dark:border-red-800">Czasownik</span>
                            <span class="px-2 py-1 bg-orange-50 text-orange-700 border border-orange-200 rounded dark:bg-orange-900/50 dark:text-orange-300 dark:border-orange-800">Operator</span>
                        </div>
                    </div>
                    <div id="eng-grammar-list" class="space-y-4"></div>
                </div>

            </div>

            <!-- Internal App Navigation -->
            <nav class="absolute bottom-0 w-full bg-white dark:bg-dark-card border-t border-slate-200 dark:border-dark-border pb-safe z-50 overflow-x-auto no-scrollbar">
                <div class="flex justify-around h-16 items-center px-4">
                    <button onclick="EnglishApp.switchTab('quiz')" id="eng-nav-quiz" class="flex flex-col items-center text-indigo-600 transition-colors"><span class="text-xl">üìù</span><span class="text-[9px] font-bold uppercase">Quiz</span></button>
                    <button onclick="EnglishApp.switchTab('scramble')" id="eng-nav-scramble" class="flex flex-col items-center text-slate-400 hover:text-indigo-400 transition-colors"><span class="text-xl">üß©</span><span class="text-[9px] font-bold uppercase">Zdania</span></button>
                    <button onclick="EnglishApp.switchTab('memory')" id="eng-nav-memory" class="flex flex-col items-center text-slate-400 hover:text-indigo-400 transition-colors"><span class="text-xl">‚ö°</span><span class="text-[9px] font-bold uppercase">Pary</span></button>
                    <button onclick="EnglishApp.switchTab('flashcards')" id="eng-nav-flashcards" class="flex flex-col items-center text-slate-400 hover:text-indigo-400 transition-colors"><span class="text-xl">üß†</span><span class="text-[9px] font-bold uppercase">Fiszki</span></button>
                    <button onclick="EnglishApp.switchTab('vocab')" id="eng-nav-vocab" class="flex flex-col items-center text-slate-400 hover:text-indigo-400 transition-colors"><span class="text-xl">üìñ</span><span class="text-[9px] font-bold uppercase">S≈Çowa</span></button>
                    <button onclick="EnglishApp.switchTab('grammar')" id="eng-nav-grammar" class="flex flex-col items-center text-slate-400 hover:text-indigo-400 transition-colors"><span class="text-xl">üéì</span><span class="text-[9px] font-bold uppercase">Teoria</span></button>
                </div>
            </nav>
        </div>

        <!-- SUMMARY MODAL -->
        <div id="summary-modal" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white dark:bg-dark-card w-full max-w-sm rounded-3xl p-8 text-center pop-up">
                <h2 class="text-2xl font-bold mb-6 dark:text-white">Wynik Sesji</h2>
                <div class="flex justify-center gap-8 mb-8">
                    <div><p class="text-xs text-slate-400 uppercase font-bold">Wynik</p><p class="text-3xl font-black text-indigo-600" id="final-score">0/0</p></div>
                    <div><p class="text-xs text-slate-400 uppercase font-bold">Czas</p><p class="text-3xl font-black text-slate-800 dark:text-white" id="final-time">00:00</p></div>
                </div>
                <button onclick="closeSummary()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold">Wr√≥ƒá do menu</button>
            </div>
        </div>

        <!-- CONFIRM MODAL (FIXED) -->
        <div id="confirm-modal" class="hidden fixed inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white dark:bg-dark-card w-full max-w-sm rounded-3xl p-6 text-center pop-in">
                <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                <h3 id="confirm-title" class="text-xl font-bold mb-2 dark:text-white">Jeste≈õ pewien?</h3>
                <p id="confirm-desc" class="text-sm text-slate-500 dark:text-slate-400 mb-6">Tej akcji nie mo≈ºna cofnƒÖƒá.</p>
                <div class="flex gap-3">
                    <button onclick="ConfirmModal.cancel()" class="flex-1 py-3 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-xl font-bold hover:bg-slate-200 transition-colors">Anuluj</button>
                    <button id="confirm-yes-btn" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg hover:bg-red-700 transition-colors">Tak, wykonaj</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- DATA ---
        const CKE_DATA = {
            polski: { 
                id: 'polski', subject: "Jƒôzyk Polski", theme: "red", icon: "üáµüá±", desc: "Literatura i jƒôzyk", label: "CKE 2024",
                features: [
                    { id: 'written', label: 'Arkusz Pisemny', icon: 'üìù', type: 'sheet' },
                    { id: 'oral', label: 'Matura Ustna', icon: 'üéôÔ∏è', type: 'oral' }
                ],
                source: "<h2>Lalka</h2><p>Wokulski spostrzeg≈Ç, ≈ºe panna Izabela patrzy na niego z wyrazem, kt√≥rego nie m√≥g≈Ç zrozumieƒá...</p>",
                tasks: [{ id: 1, type: "radio", question: "G≈Ç√≥wny dyskomfort Wokulskiego wynika z:", options: ["Atmosfery sali", "Poczucia nieadekwatno≈õci", "Problem√≥w finansowych"], correct: 1, explanation: "Wokulski czuje siƒô obco w≈õr√≥d arystokracji." }],
                oral_question: "Motyw winy i kary w literaturze. Om√≥w zagadnienie na podstawie 'Makbeta'.",
                oral_criteria: ["Zdefiniowanie zbrodni Makbeta jako z≈Çamania praw.", "Rola Lady Makbet jako inicjatorki z≈Ça.", "Wyrzuty sumienia (omamy, krew).", "Kontekst innego utworu literatury."]
            },
            matematyka: { 
                id: 'matematyka', subject: "Matematyka", theme: "blue", icon: "üìê", desc: "Analiza i funkcje", label: "CKE 2024",
                features: [{ id: 'written', label: 'Arkusz Podstawowy', icon: 'üìê', type: 'sheet' }],
                source: "<h2>Funkcja</h2><p>$$f(x) = -x^2 + 4x + 5$$</p>",
                tasks: [{ id: 1, type: "radio", question: "Wsp√≥≈Çrzƒôdna p wierzcho≈Çka to:", options: ["2", "-2", "4"], correct: 0, explanation: "$p = -4 / (2*-1) = 2$." }]
            },
            angielski: { 
                id: 'angielski', subject: "Jƒôzyk Angielski", theme: "indigo", icon: "üá¨üáß", desc: "Kompletny modu≈Ç Prep", label: "Ultimate",
                features: [
                    { id: 'quiz', label: 'Maturalny Quiz', icon: 'üìù', type: 'eng_tab' },
                    { id: 'scramble', label: 'Uk≈Çadanka Zda≈Ñ', icon: 'üß©', type: 'eng_tab' },
                    { id: 'memory', label: 'Szybkie Pary', icon: '‚ö°', type: 'eng_tab' },
                    { id: 'flashcards', label: 'Fiszki 3D', icon: 'üß†', type: 'eng_tab' },
                    { id: 'vocab', label: 'S≈Çownik', icon: 'üìñ', type: 'eng_tab' },
                    { id: 'grammar', label: 'Teoria SVO', icon: 'üéì', type: 'eng_tab' }
                ]
            },
            chemia: { 
                id: 'chemia', subject: "Chemia", theme: "teal", icon: "üß™", desc: "Reakcje i kwasy", label: "Nowy Arkusz",
                features: [{ id: 'written', label: 'Arkusz Rozszerzony', icon: 'üß™', type: 'sheet' }],
                source: "<h2>H2SO4</h2><p>$$SO_3 + H_2O \\rightarrow H_2SO_4$$</p>",
                tasks: [{ id: 1, type: "radio", question: "Bezwodnik H2SO4 to:", options: ["SO2", "SO3"], correct: 1, explanation: "SO3 to tlenek siarki(VI)." }]
            },
            biologia: {
                id: 'biologia', subject: "Biologia", theme: "green", icon: "üß¨", desc: "Krzy≈º√≥wki Genetyczne", label: "Wykresy",
                features: [{ id: 'written', label: 'Arkusz Rozszerzony', icon: 'üß¨', type: 'sheet' }],
                source: "<h2>Dziedziczenie</h2><div class='bg-slate-100 dark:bg-slate-800 p-4 rounded text-center mb-4'>Aa x Aa</div><p>Cecha A (ciemne oczy) dominuje nad cechƒÖ a (jasne oczy).</p>",
                tasks: [{ id: 1, type: "radio", question: "Jakie jest prawdopodobie≈Ñstwo urodzenia dziecka o jasnych oczach (aa)?", options: ["25%", "50%", "75%"], correct: 0, explanation: "Rozk≈Çad genotyp√≥w: AA (25%), Aa (50%), aa (25%)." }]
            },
            geografia: { 
                id: 'geografia', subject: "Geografia", theme: "yellow", icon: "üåç", desc: "Ziemia i mapy", label: "CKE",
                features: [{ id: 'written', label: 'Arkusz Pisemny', icon: 'üåç', type: 'sheet' }],
                source: "<h2>Tektonika</h2><p>P≈Çyty litosfery przemieszczajƒÖ siƒô wzglƒôdem siebie.</p>",
                tasks: [{ id: 1, type: "radio", question: "Trzƒôsienia wystƒôpujƒÖ:", options: ["W ≈õrodku p≈Çyt", "Na granicach"], correct: 1, explanation: "Najwiƒôksza aktywno≈õƒá na stykach p≈Çyt." }]
            }
        };

        // --- GLOBAL STATE ---
        const STORAGE_KEY = 'matura_cloud_ultimate_v9_6_4';
        let userProgress = { 
            totalScoreSum: 0, 
            sheetsCount: 0, 
            scoresBySubject: {}, 
            attemptsBySubject: {}, 
            streak: 1, 
            lastLogin: new Date().toDateString(),
            userName: 'Piotr', 
            englishApp: {
                quiz: { queue: [], currentIndex: 0, score: 0, wrongIds: [] },
                flash: { knownIds: [] }
            }
        };
        let timerInterval, activeSubjectKey = '', sessionStats = {correct: 0, total: 0}, currentOralScore = 0;

        // --- CUSTOM MODAL FOR CONFIRMATIONS (FIXED LOGIC) ---
        const ConfirmModal = {
            onConfirm: null,
            show: function(title, desc, onConfirmCallback) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-desc').textContent = desc;
                this.onConfirm = onConfirmCallback;
                
                document.getElementById('confirm-yes-btn').onclick = () => {
                    // UWAGA: Trzeba przechwyciƒá callback przed zamkniƒôciem modala
                    const callback = this.onConfirm; 
                    this.hide(); 
                    if(callback) callback(); // W≈Ça≈õciwe wykonanie logiki resetu
                };
                
                document.getElementById('confirm-modal').classList.remove('hidden');
            },
            hide: function() {
                document.getElementById('confirm-modal').classList.add('hidden');
                this.onConfirm = null;
            },
            cancel: function() {
                this.hide();
            }
        };

        // --- ENGLISH MODULE LOGIC ---
        const EnglishApp = {
            vocab: [
                { id: 'v1', en: "do household chores", pl: "wykonywaƒá prace domowe", ex: "I hate doing household chores." },
                { id: 'v2', en: "tidy up", pl: "sprzƒÖtaƒá", ex: "This room needs tidying up." },
                { id: 'v3', en: "rent", pl: "wynajƒÖƒá (jako lokator)", ex: "I want to rent a flat." },
                { id: 'v4', en: "let", pl: "wynajƒÖƒá (komu≈õ)", ex: "He lets his flat to students." },
                { id: 'v5', en: "breathtaking view", pl: "zapierajƒÖcy dech widok", ex: "A room with a breathtaking view." },
                { id: 'v6', en: "get used to (+ing)", pl: "przyzwyczaiƒá siƒô do", ex: "I can't get used to getting up early." },
                { id: 'v7', en: "be used to (+ing)", pl: "byƒá przyzwyczajonym do", ex: "I am used to noise." },
                { id: 'v8', en: "put somebody up", pl: "przenocowaƒá kogo≈õ", ex: "Can you put me up for tonight?" },
                { id: 'v9', en: "can't stand", pl: "nie m√≥c znie≈õƒá", ex: "I can't stand working here." },
                { id: 'v10', en: "make somebody do", pl: "zmuszaƒá kogo≈õ do", ex: "He made me cry." },
                { id: 'v11', en: "be made to do", pl: "byƒá zmuszonym do", ex: "I was made to tidy up." },
                { id: 'v12', en: "I'd rather not", pl: "wola≈Çbym nie", ex: "Do you want to go? I'd rather not." },
                { id: 'v13', en: "try on", pl: "przymierzyƒá (ubranie)", ex: "You should try it on." },
                { id: 'v14', en: "be into something", pl: "interesowaƒá siƒô / lubiƒá", ex: "I'm not into dancing." },
                { id: 'v15', en: "keen on", pl: "bardzo lubiƒá / zapalony do", ex: "I'm keen on sports." },
                { id: 'v16', en: "fed up with", pl: "mieƒá do≈õƒá czego≈õ", ex: "I'm fed up with your lies." },
                { id: 'v17', en: "give up (+ing)", pl: "rzuciƒá / poddaƒá siƒô", ex: "I gave up smoking." },
                { id: 'v18', en: "go with", pl: "pasowaƒá (do czego≈õ)", ex: "This bag goes with your shoes." },
                { id: 'v19', en: "take after", pl: "odziedziczyƒá cechy", ex: "You take after your father." },
                { id: 'v20', en: "out of order", pl: "zepsuty (maszyna)", ex: "The lift is out of order." },
                { id: 'v21', en: "boiling", pl: "upalny / wrzƒÖcy", ex: "It's boiling outside." },
                { id: 'v22', en: "likely to", pl: "prawdopodobny", ex: "It's likely to rain." },
                { id: 'v23', en: "go abroad", pl: "wyjechaƒá za granicƒô", ex: "He has gone abroad." },
                { id: 'v24', en: "It's high time", pl: "najwy≈ºszy czas", ex: "It's high time we went home." },
                { id: 'v25', en: "If I were you", pl: "na twoim miejscu", ex: "If I were you, I would buy it." },
                { id: 'v26', en: "have something done", pl: "zleciƒá co≈õ", ex: "I must have my car repaired." }
            ],
            grammar: [
                {
                    title: "Budowa Zdania (TwierdzƒÖce)",
                    desc: "Z≈Çota zasada angielskiego: SVO (Subject-Verb-Object). Kto? Co robi? Co/Gdzie?",
                    structure: [{ type: 'sub', text: "Kto? (Subject)" }, { type: 'verb', text: "Co robi? (Verb)" }, { type: 'obj', text: "Reszta (Object)" }],
                    examples: [
                        { en: "Tom eats pizza.", pl: "Tom je pizzƒô.", blocks: [["Tom", "sub"], ["eats", "verb"], ["pizza", "obj"]] },
                        { en: "We live in Poland.", pl: "Mieszkamy w Polsce.", blocks: [["We", "sub"], ["live", "verb"], ["in Poland", "obj"]] }
                    ]
                },
                {
                    title: "Pytania i Przeczenia (Operator)",
                    desc: "W angielskim potrzebujesz 'pomocnika' (Operatora) do pyta≈Ñ i przecze≈Ñ. Operator bierze na siebie gramatykƒô.",
                    structure: [{ type: 'op', text: "Operator" }, { type: 'sub', text: "Kto?" }, { type: 'verb', text: "Czasownik (Baza)" }],
                    examples: [
                        { en: "Do you like coffee?", pl: "Lubisz kawƒô?", blocks: [["Do", "op"], ["you", "sub"], ["like", "verb"], ["coffee?", "obj"]] },
                        { en: "He doesn't work here.", pl: "On tu nie pracuje.", blocks: [["He", "sub"], ["doesn't", "op"], ["work", "verb"], ["here", "obj"]] }
                    ]
                },
                {
                    title: "Present Simple (Rutyna)",
                    desc: "Fakty, nawyki, rozk≈Çady jazdy. S≈Çowa klucze: always, usually, every day.",
                    structure: [{ type: 'sub', text: "Kto" }, { type: 'verb', text: "Czasownik (+s dla On/Ona)" }],
                    examples: [{ en: "She drinks tea.", pl: "Ona pije herbatƒô (og√≥lnie).", blocks: [["She", "sub"], ["drinks", "verb"], ["tea", "obj"]] }]
                },
                {
                    title: "Present Continuous (Teraz)",
                    desc: "Dzieje siƒô w tym momencie. S≈Çowa klucze: now, at the moment.",
                    structure: [{ type: 'sub', text: "Kto" }, { type: 'verb', text: "am/is/are" }, { type: 'verb', text: "Czasownik + ING" }],
                    examples: [{ en: "She is drinking tea.", pl: "Ona pije herbatƒô (w tej chwili).", blocks: [["She", "sub"], ["is", "verb"], ["drinking", "verb"], ["tea", "obj"]] }]
                },
                {
                    title: "Past Simple (Przesz≈Ço≈õƒá)",
                    desc: "Czynno≈õƒá zako≈Ñczona w przesz≈Ço≈õci. Daty, wczoraj. Operator: DID.",
                    structure: [{ type: 'sub', text: "Kto" }, { type: 'verb', text: "2. Forma / -ed" }],
                    examples: [
                        { en: "I watched TV yesterday.", pl: "OglƒÖda≈Çem TV wczoraj.", blocks: [["I", "sub"], ["watched", "verb"], ["TV", "obj"], ["yesterday", "extra"]] },
                        { en: "Did you go there?", pl: "Poszed≈Çe≈õ tam?", blocks: [["Did", "op"], ["you", "sub"], ["go", "verb"], ["there?", "extra"]] }
                    ]
                },
                {
                    title: "Causative Have (Mieƒá co≈õ zrobione)",
                    desc: "U≈ºywamy, gdy NIE robimy czego≈õ sami, ale zlecamy to komu≈õ (np. mechanikowi, fryzjerowi).",
                    structure: [{ type: 'sub', text: "Podmiot" }, { type: 'verb', text: "Have" }, { type: 'obj', text: "Co≈õ" }, { type: 'verb', text: "3. Forma" }],
                    examples: [
                        { en: "I have my car repaired.", pl: "Naprawiam samoch√≥d (u mechanika).", blocks: [["I", "sub"], ["have", "verb"], ["my car", "obj"], ["repaired", "verb"]] },
                        { en: "She had her hair cut.", pl: "Ona ≈õciƒô≈Ça w≈Çosy (u fryzjera).", blocks: [["She", "sub"], ["had", "verb"], ["her hair", "obj"], ["cut", "verb"]] }
                    ]
                },
                {
                    title: "Passive Voice (Strona Bierna)",
                    desc: "Wa≈ºniejsza jest czynno≈õƒá lub obiekt, a nie osoba wykonujƒÖca. Czƒôste w instrukcjach i wiadomo≈õciach.",
                    structure: [{ type: 'obj', text: "Obiekt" }, { type: 'verb', text: "To Be" }, { type: 'verb', text: "3. Forma" }],
                    examples: [
                        { en: "This room needs tidying up.", pl: "Ten pok√≥j wymaga sprzƒÖtania.", blocks: [["This room", "obj"], ["needs", "verb"], ["tidying up", "verb"]] },
                        { en: "Dinner is served.", pl: "Obiad jest podany.", blocks: [["Dinner", "obj"], ["is", "verb"], ["served", "verb"]] }
                    ]
                },
                {
                    title: "It's High Time (Najwy≈ºszy Czas)",
                    desc: "Specyficzna konstrukcja. Mimo ≈ºe m√≥wimy o teraz/przysz≈Ço≈õci, u≈ºywamy czasu przesz≈Çego!",
                    structure: [{ type: 'extra', text: "It's high time" }, { type: 'sub', text: "Kto≈õ" }, { type: 'verb', text: "Past Simple" }],
                    examples: [{ en: "It's high time we went home.", pl: "Najwy≈ºszy czas, by≈õmy poszli do domu.", blocks: [["It's high time", "extra"], ["we", "sub"], ["went", "verb"], ["home", "extra"]] }]
                },
                {
                    title: "2nd Conditional (Gdybanie)",
                    desc: "Sytuacje hipotetyczne, ma≈Ço realne w tera≈∫niejszo≈õci. 'Gdybym by≈Ç TobƒÖ...'",
                    structure: [{ type: 'extra', text: "If" }, { type: 'sub', text: "Podmiot" }, { type: 'verb', text: "Past Simple" }, { type: 'extra', text: "," }, { type: 'sub', text: "Podmiot" }, { type: 'verb', text: "Would + Czasownik" }],
                    examples: [{ en: "If I were you, I would buy it.", pl: "Na Twoim miejscu bym to kupi≈Ç.", blocks: [["If", "extra"], ["I", "sub"], ["were", "verb"], ["you", "obj"], ["I", "sub"], ["would buy", "verb"], ["it", "obj"]] }]
                },
                {
                    title: "Get Used To (Przyzwyczaiƒá siƒô)",
                    desc: "Opisuje proces zmiany. Bardzo wa≈ºne: po 'to' ZAWSZE dajemy czasownik z ko≈Ñc√≥wkƒÖ -ING.",
                    structure: [{ type: 'sub', text: "Podmiot" }, { type: 'verb', text: "Get used to" }, { type: 'verb', text: "Czasownik + ING" }],
                    examples: [{ en: "I can't get used to getting up early.", pl: "Nie mogƒô przywyknƒÖƒá do wstawania rano.", blocks: [["I", "sub"], ["can't get used to", "verb"], ["getting up", "verb"], ["early", "extra"]] }]
                }
            ],
            quiz: [
                { id: 1, category: "Dom", question: "Do you know anyone who likes _____ household chores?", context: "Lubi ROBIƒÜ prace domowe.", options: ["making", "to make", "doing"], correct: 2, explanation: "Z 'chores' u≈ºywamy DO. Po 'like' u≈ºywamy -ing." },
                { id: 2, category: "Dom", question: "This room needs _____ if you want to invite friends.", context: "Wymaga posprzƒÖtania (strona bierna)", options: ["tidying up", "to tidy up", "being tidied up"], correct: 0, explanation: "'It needs doing' = wymaga zrobienia." },
                { id: 3, category: "Dom", question: "I'm looking for a room to _____.", context: "Szukam pokoju do wynajƒôcia (dla siebie).", options: ["let", "rent", "borrow"], correct: 1, explanation: "Lokator chce 'rent'. W≈Ça≈õciciel 'lets'." },
                { id: 4, category: "Dom", question: "The hotel had a breathtaking _____ over the mountains.", context: "Widok na g√≥ry.", options: ["sight", "view", "look"], correct: 1, explanation: "'View' = widok krajobrazu." },
                { id: 5, category: "Gramatyka", question: "I _____ a room with five other people.", context: "Nie mog≈Çam siƒô przyzwyczaiƒá.", options: ["didn't use to share", "wasn't used to sharing", "couldn't get used to sharing"], correct: 2, explanation: "'Get used to' = proces przyzwyczajania siƒô." },
                { id: 7, category: "Phrasal", question: "My friend Betty put me up for the night.", context: "Co znaczy 'put me up'?", options: ["picked me up", "tolerated me", "let me stay"], correct: 2, explanation: "'Put someone up' = przenocowaƒá kogo≈õ." },
                { id: 9, category: "Gramatyka", question: "My brother made me tidy our room.", context: "Strona bierna: Kazano mi.", options: ["I was encouraged", "I wanted to tidy", "I was told to tidy"], correct: 2, explanation: "Make sb do sth -> Be told to do sth." },
                { id: 24, category: "Gramatyka", question: "It's high time I _____ home.", context: "Czas i≈õƒá do domu.", options: ["go", "went", "have gone"], correct: 1, explanation: "High time + Past Simple." },
                { id: 25, category: "Gramatyka", question: "If I _____ you, I would buy flowers.", context: "Na twoim miejscu.", options: ["am", "was", "were"], correct: 2, explanation: "If I WERE you." }
            ],
            scramble: [
                { text: "It is high time we went home", trans: "Najwy≈ºszy czas, ≈ºeby≈õmy poszli do domu" },
                { text: "I must have my car repaired", trans: "Muszƒô daƒá samoch√≥d do naprawy" },
                { text: "If I were you I would apologize", trans: "Na twoim miejscu bym przeprosi≈Ç" },
                { text: "This room needs tidying up", trans: "Ten pok√≥j wymaga posprzƒÖtania" },
                { text: "I was told to tidy my room", trans: "Kazano mi posprzƒÖtaƒá m√≥j pok√≥j" },
                { text: "I am fed up with your lies", trans: "Mam dosyƒá twoich k≈Çamstw" },
                { text: "Can you put me up for tonight", trans: "Mo≈ºesz mnie przenocowaƒá na dzisiaj?" }
            ],
            
            scrambleIdx: 0, flashIdx: 0, isFlipped: false, flashQueue: [],

            // Flagi zapobiegajƒÖce wy≈õcigom zdarze≈Ñ
            _isRatingFlashcard: false,

            init: function() {
                this.renderVocab(this.vocab);
                this.renderGrammar();
                this.checkResumeState();
                this.updateFlashStats();
            },

            // --- QUIZ LOGIC ---
            checkResumeState: function() {
                const s = userProgress.englishApp.quiz;
                if (s.queue.length > 0 && s.currentIndex < s.queue.length) {
                    document.getElementById('eng-resume-section').classList.remove('hidden');
                } else {
                    document.getElementById('eng-resume-section').classList.add('hidden');
                }
                
                if (s.wrongIds && s.wrongIds.length > 0) {
                    document.getElementById('eng-error-review-section').classList.remove('hidden');
                    document.getElementById('eng-error-count').textContent = s.wrongIds.length;
                } else {
                    document.getElementById('eng-error-review-section').classList.add('hidden');
                }
            },
            
            shuffleArray: function(arr) { return arr.sort(() => Math.random() - 0.5); },
            
            startNewQuiz: function() {
                userProgress.englishApp.quiz.queue = this.shuffleArray(this.quiz.map(q => q.id));
                userProgress.englishApp.quiz.currentIndex = 0; 
                userProgress.englishApp.quiz.score = 0;
                this.runQuizSetup();
            },
            
            resumeQuiz: function() { this.runQuizSetup(); },
            
            startErrorReview: function() {
                userProgress.englishApp.quiz.queue = this.shuffleArray([...userProgress.englishApp.quiz.wrongIds]);
                userProgress.englishApp.quiz.currentIndex = 0; 
                userProgress.englishApp.quiz.score = 0; 
                userProgress.englishApp.quiz.wrongIds = [];
                this.runQuizSetup();
            },
            
            runQuizSetup: function() {
                document.getElementById('eng-start-screen').classList.add('hidden');
                document.getElementById('eng-results-screen').classList.add('hidden');
                document.getElementById('eng-quiz-container').classList.remove('hidden');
                this.loadQuiz();
                saveState();
            },
            
            showQuizStart: function() {
                document.getElementById('eng-quiz-container').classList.add('hidden');
                document.getElementById('eng-results-screen').classList.add('hidden');
                document.getElementById('eng-start-screen').classList.remove('hidden');
                this.checkResumeState();
            },

            loadQuiz: function() {
                if (userProgress.englishApp.quiz.currentIndex >= userProgress.englishApp.quiz.queue.length) return;
                
                const qId = userProgress.englishApp.quiz.queue[userProgress.englishApp.quiz.currentIndex];
                const d = this.quiz.find(q => q.id === qId);
                
                if (!d) return;

                document.getElementById('eng-explanation-card').classList.add('hidden');
                document.getElementById('eng-question-text').textContent = d.question;
                document.getElementById('eng-category-tag').textContent = d.category;
                document.getElementById('eng-q-counter').textContent = `${userProgress.englishApp.quiz.currentIndex + 1}/${userProgress.englishApp.quiz.queue.length}`;
                
                if(d.context) {
                    document.getElementById('eng-context-box').classList.remove('hidden');
                    document.getElementById('eng-context-text').textContent = d.context;
                } else {
                    document.getElementById('eng-context-box').classList.add('hidden');
                }

                const cont = document.getElementById('eng-options-container'); 
                cont.innerHTML = '';
                d.options.forEach((opt, i) => {
                    const b = document.createElement('button');
                    b.className = "w-full text-left p-4 rounded-xl border dark:border-slate-700 bg-white dark:bg-dark-card text-sm dark:text-white transition-all active:scale-95 shadow-sm";
                    b.textContent = opt; 
                    b.onclick = () => this.checkQuizAns(i, b, d);
                    cont.appendChild(b);
                });
            },

            checkQuizAns: function(idx, b, data) {
                const btns = document.getElementById('eng-options-container').querySelectorAll('button');
                btns.forEach(x => x.disabled = true);
                
                if(idx === data.correct) {
                    userProgress.englishApp.quiz.score++;
                    b.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/20', 'text-green-800', 'correct-anim');
                } else {
                    b.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20', 'text-red-800', 'wrong-anim');
                    if (btns[data.correct]) {
                        btns[data.correct].classList.add('bg-green-50', 'dark:bg-green-900/10', 'border-green-400', 'text-green-700');
                    }
                    if(!userProgress.englishApp.quiz.wrongIds.includes(data.id)) {
                        userProgress.englishApp.quiz.wrongIds.push(data.id);
                    }
                }
                saveState();
                document.getElementById('eng-explanation-text').textContent = data.explanation;
                document.getElementById('eng-explanation-card').classList.remove('hidden');
            },

            nextQuestion: function() {
                if (userProgress.englishApp.quiz.currentIndex >= userProgress.englishApp.quiz.queue.length) return;
                
                userProgress.englishApp.quiz.currentIndex++;
                saveState();
                if(userProgress.englishApp.quiz.currentIndex < userProgress.englishApp.quiz.queue.length) {
                    this.loadQuiz();
                } else {
                    const final = Math.round((userProgress.englishApp.quiz.score / userProgress.englishApp.quiz.queue.length)*100);
                    updateGlobalStats(final, 'angielski');
                    document.getElementById('eng-quiz-container').classList.add('hidden');
                    document.getElementById('eng-results-screen').classList.remove('hidden');
                    document.getElementById('eng-final-score').textContent = `${final}%`;
                }
            },

            // --- SCRAMBLE LOGIC ---
            startScramble: function() {
                this.scrambleIdx = 0;
                document.getElementById('eng-scramble-start').classList.add('hidden');
                document.getElementById('eng-scramble-game').classList.remove('hidden');
                this.loadScramble();
            },
            showScrambleStart: function() {
                document.getElementById('eng-scramble-game').classList.add('hidden');
                document.getElementById('eng-scramble-start').classList.remove('hidden');
            },
            loadScramble: function() {
                const d = this.scramble[this.scrambleIdx];
                document.getElementById('eng-scramble-counter').textContent = `${this.scrambleIdx + 1}/${this.scramble.length}`;
                document.getElementById('eng-scramble-translation').textContent = d.trans;
                document.getElementById('eng-scramble-feedback').classList.add('hidden');
                document.getElementById('eng-scramble-next-btn').classList.add('hidden');
                document.getElementById('eng-scramble-check-btn').classList.remove('hidden');
                const bank = document.getElementById('eng-scramble-bank');
                const drop = document.getElementById('eng-scramble-dropzone');
                bank.innerHTML = ''; drop.innerHTML = '';
                d.text.split(' ').sort(()=>Math.random()-0.5).forEach(word => {
                    const b = document.createElement('button');
                    b.className = "px-4 py-2 bg-white dark:bg-dark-card border border-slate-200 dark:border-slate-700 rounded-full shadow-sm text-sm dark:text-white active:scale-95 transition-transform pop-in";
                    b.textContent = word; 
                    b.onclick = () => { 
                        if(b.parentElement === bank) { drop.appendChild(b); b.classList.add('bg-purple-50', 'text-purple-700', 'border-purple-200'); } 
                        else { bank.appendChild(b); b.classList.remove('bg-purple-50', 'text-purple-700', 'border-purple-200'); }
                    };
                    bank.appendChild(b);
                });
            },
            checkScramble: function() {
                const drop = document.getElementById('eng-scramble-dropzone');
                const user = Array.from(drop.children).map(x=>x.textContent).join(' ');
                const correct = this.scramble[this.scrambleIdx].text;
                const fb = document.getElementById('eng-scramble-feedback');
                if(user === correct) {
                    fb.textContent = "Brawo!"; fb.className = "mt-4 text-center p-3 rounded-lg font-bold bg-green-100 text-green-700 block pop-in";
                    document.getElementById('eng-scramble-check-btn').classList.add('hidden');
                    document.getElementById('eng-scramble-next-btn').classList.remove('hidden');
                } else {
                    fb.textContent = "≈πle..."; fb.className = "mt-4 text-center p-3 rounded-lg font-bold bg-red-100 text-red-700 block wrong-anim";
                }
                fb.classList.remove('hidden');
            },
            nextScramble: function() {
                this.scrambleIdx++;
                if(this.scrambleIdx < this.scramble.length) this.loadScramble();
                else this.showScrambleStart();
            },

            // --- MEMORY LOGIC ---
            startMemory: function() {
                document.getElementById('eng-memory-start').classList.add('hidden');
                document.getElementById('eng-memory-win').classList.add('hidden');
                document.getElementById('eng-memory-game').classList.remove('hidden');
                this.matchesLeft = 6;
                document.getElementById('eng-memory-score').textContent = 6;
                const grid = document.getElementById('eng-memory-grid'); grid.innerHTML = '';
                const items = this.vocab.sort(()=>Math.random()-0.5).slice(0, 6);
                let cards = [];
                items.forEach(v => { cards.push({id:v.id,txt:v.en}); cards.push({id:v.id,txt:v.pl}); });
                cards.sort(()=>Math.random()-0.5).forEach(c => {
                    const el = document.createElement('div');
                    el.className = "bg-white dark:bg-dark-card border-2 border-slate-200 dark:border-slate-700 rounded-xl p-3 flex items-center justify-center text-center text-[10px] font-bold dark:text-white min-h-[70px] cursor-pointer shadow-sm active:scale-95 transition-all";
                    el.textContent = c.txt; el.dataset.id = c.id;
                    el.onclick = () => this.handleMatch(el);
                    grid.appendChild(el);
                });
            },
            showMemoryStart: function() {
                document.getElementById('eng-memory-win').classList.add('hidden');
                document.getElementById('eng-memory-game').classList.add('hidden');
                document.getElementById('eng-memory-start').classList.remove('hidden');
            },
            selectedMatch: null,
            handleMatch: function(el) {
                if(el.classList.contains('fade-out')) return;
                if(this.selectedMatch === el) { el.classList.remove('border-pink-500', 'bg-pink-50', 'dark:bg-pink-900/10', 'text-pink-600'); this.selectedMatch = null; return; }
                el.classList.add('border-pink-500', 'bg-pink-50', 'dark:bg-pink-900/10', 'text-pink-600');
                
                if(!this.selectedMatch) this.selectedMatch = el;
                else {
                    const prev = this.selectedMatch;
                    if(prev.dataset.id === el.dataset.id) {
                        [prev, el].forEach(x => { x.classList.replace('border-pink-500','border-green-500'); x.classList.add('fade-out'); });
                        this.matchesLeft--;
                        document.getElementById('eng-memory-score').textContent = this.matchesLeft;
                        if(this.matchesLeft === 0) setTimeout(()=>document.getElementById('eng-memory-win').classList.remove('hidden'), 500);
                    } else {
                        [prev, el].forEach(x => { x.classList.add('wrong-anim'); setTimeout(()=>x.classList.remove('wrong-anim','border-pink-500','bg-pink-50','dark:bg-pink-900/10','text-pink-600'), 500); });
                    }
                    this.selectedMatch = null;
                }
            },

            // --- FLASHCARDS LOGIC ---
            updateFlashStats: function() {
                document.getElementById('eng-flash-total-count').textContent = this.vocab.length;
                document.getElementById('eng-flash-known-count').textContent = userProgress.englishApp.flash.knownIds.length;
            },
            
            showFlashcardStart: function() {
                document.getElementById('eng-flash-game').classList.add('hidden');
                document.getElementById('eng-flash-done').classList.add('hidden');
                document.getElementById('eng-flash-start').classList.remove('hidden');
                this.updateFlashStats();
            },

            startFlashcards: function() {
                const unknown = this.vocab.filter(w => !userProgress.englishApp.flash.knownIds.includes(w.id));
                this.flashQueue = unknown.length > 0 ? this.shuffleArray([...unknown]) : this.shuffleArray([...this.vocab]);
                this.flashIdx = 0;
                this.isFlipped = false;
                this._isRatingFlashcard = false;
                
                if (!this.flashQueue || this.flashQueue.length === 0) {
                    this.showFlashcardStart();
                    return;
                }
                
                document.getElementById('eng-flash-start').classList.add('hidden');
                document.getElementById('eng-flash-done').classList.add('hidden');
                document.getElementById('eng-flash-game').classList.remove('hidden');
                this.loadFlashCard();
            },

            loadFlashCard: function() {
                // Bezwzglƒôdny stra≈ºnik przed b≈Çƒôdem undefined object
                if (!this.flashQueue || this.flashQueue.length === 0) return;
                if (this.flashIdx >= this.flashQueue.length) return; 
                
                const c = this.flashQueue[this.flashIdx];
                if (!c || !c.en) return; // Zapobiega TypeError: Cannot read properties of undefined

                document.getElementById('eng-flash-front').textContent = c.en;
                document.getElementById('eng-flash-back').textContent = c.pl || '';
                document.getElementById('eng-flash-example').textContent = `"${c.ex || ''}"`;
                document.getElementById('eng-flash-counter').textContent = `${this.flashIdx + 1}/${this.flashQueue.length}`;
                document.getElementById('eng-flash-inner').classList.remove('rotate-y-180');
                this.isFlipped = false;
            },

            flipCard: function() {
                this.isFlipped = !this.isFlipped;
                document.getElementById('eng-flash-inner').classList.toggle('rotate-y-180');
            },

            rateFlashcard: function(known) {
                if (this._isRatingFlashcard) return;
                this._isRatingFlashcard = true;

                const currentCard = this.flashQueue[this.flashIdx];
                if (!currentCard) {
                    this._isRatingFlashcard = false;
                    return;
                }

                if(known) {
                    if(!userProgress.englishApp.flash.knownIds.includes(currentCard.id)) {
                        userProgress.englishApp.flash.knownIds.push(currentCard.id);
                    }
                }
                
                saveState();
                this.flashIdx++;
                
                if(this.flashIdx < this.flashQueue.length) {
                    setTimeout(() => {
                        this.loadFlashCard();
                        this._isRatingFlashcard = false;
                    }, 150);
                } else {
                    document.getElementById('eng-flash-game').classList.add('hidden');
                    document.getElementById('eng-flash-done').classList.remove('hidden');
                    this.updateFlashStats();
                    this._isRatingFlashcard = false;
                }
            },
            
            resetFlashcards: function() {
                ConfirmModal.show(
                    "Reset fiszek", 
                    "Czy na pewno chcesz odznaczyƒá wszystkie ju≈º nauczone s≈Ç√≥wka?", 
                    () => {
                        userProgress.englishApp.flash.knownIds = [];
                        saveState();
                        EnglishApp.updateFlashStats();
                        EnglishApp.showFlashcardStart();
                    }
                );
            },

            // --- UI & TAB LOGIC ---
            switchTab: function(tab) {
                const activeNav = document.getElementById(`eng-nav-${tab}`);
                const isActive = activeNav && !activeNav.classList.contains('text-slate-400');

                ['quiz','scramble','memory','flashcards','vocab','grammar'].forEach(t => {
                    const el = document.getElementById(`eng-view-${t}`);
                    if(el) el.classList.add('hidden', 'opacity-0');
                    const nav = document.getElementById(`eng-nav-${t}`);
                    if(nav) nav.classList.add('text-slate-400');
                });
                
                const active = document.getElementById(`eng-view-${tab}`);
                if(active) {
                    active.classList.remove('hidden');
                    setTimeout(() => active.classList.remove('opacity-0'), 10);
                }
                if(activeNav) activeNav.classList.remove('text-slate-400');
                
                if(isActive) {
                    if(tab === 'quiz') this.showQuizStart();
                    if(tab === 'scramble') this.showScrambleStart();
                    if(tab === 'memory') this.showMemoryStart();
                    if(tab === 'flashcards') this.showFlashcardStart();
                } else {
                    if(tab === 'flashcards') {
                        this.updateFlashStats();
                        if (!document.getElementById('eng-flash-done').classList.contains('hidden')) {
                            this.showFlashcardStart();
                        }
                    }
                    if(tab === 'quiz') {
                        this.checkResumeState();
                        if (!document.getElementById('eng-results-screen').classList.contains('hidden')) {
                            this.showQuizStart();
                        }
                    }
                    if(tab === 'memory') {
                        if (!document.getElementById('eng-memory-win').classList.contains('hidden')) {
                            this.showMemoryStart();
                        }
                    }
                    if(tab === 'scramble') {
                        if (document.getElementById('eng-scramble-next-btn') && !document.getElementById('eng-scramble-next-btn').classList.contains('hidden') && this.scrambleIdx >= this.scramble.length - 1) {
                            this.showScrambleStart();
                        }
                    }
                }
            },

            filterVocab: function() {
                const q = document.getElementById('eng-vocab-search').value.toLowerCase();
                this.renderVocab(this.vocab.filter(v => v.en.toLowerCase().includes(q) || v.pl.toLowerCase().includes(q)));
            },
            renderVocab: function(data) {
                const list = document.getElementById('eng-vocab-list'); list.innerHTML = '';
                data.forEach(v => {
                    list.innerHTML += `<div class="bg-white dark:bg-dark-card p-4 rounded-xl border border-slate-100 dark:border-dark-border flex justify-between items-center shadow-sm"><div class="flex-1"><span class="text-indigo-600 dark:text-indigo-400 font-bold block">${v.en}</span><span class="text-slate-500 text-xs italic">${v.pl}</span></div><button onclick="EnglishApp.speak('${v.en.replace(/'/g, "\\'")}')" class="p-2 text-slate-400 hover:text-indigo-500 transition-colors">üîä</button></div>`;
                });
            },
            renderGrammar: function() {
                const list = document.getElementById('eng-grammar-list'); list.innerHTML = '';
                this.grammar.forEach(g => {
                    let structHtml = '';
                    g.structure.forEach(s => {
                        let c = 'gb-extra';
                        if(s.type === 'sub') c = 'gb-subject';
                        if(s.type === 'verb') c = 'gb-verb';
                        if(s.type === 'obj') c = 'gb-object';
                        if(s.type === 'op') c = 'gb-op';
                        structHtml += `<span class="g-block ${c}">${s.text}</span>`;
                    });
                    let exHtml = '';
                    g.examples.forEach(ex => {
                        let blocks = '';
                        ex.blocks.forEach(blk => {
                            let c = 'gb-extra';
                            if(blk[1] === 'sub') c = 'gb-subject';
                            if(blk[1] === 'verb') c = 'gb-verb';
                            if(blk[1] === 'obj') c = 'gb-object';
                            if(blk[1] === 'op') c = 'gb-op';
                            blocks += `<span class="g-block ${c}">${blk[0]}</span>`;
                        });
                        exHtml += `<div class="mt-3 pt-3 border-t border-slate-50 dark:border-slate-700"><div>${blocks}</div><p class="text-xs text-slate-400 italic mt-1">${ex.pl}</p></div>`;
                    });
                    list.innerHTML += `<div class="bg-white dark:bg-dark-card p-5 rounded-xl border border-slate-100 dark:border-dark-border shadow-sm"><h4 class="font-bold mb-1 dark:text-white">${g.title}</h4><p class="text-sm text-slate-500 dark:text-slate-400 mb-3 leading-snug">${g.desc}</p><div class="mb-2 text-xs uppercase font-bold text-slate-300">Konstrukcja:</div><div>${structHtml}</div>${exHtml}</div>`;
                });
            },
            speak: function(txt) { const u = new SpeechSynthesisUtterance(txt); u.lang = 'en-GB'; window.speechSynthesis.speak(u); }
        };

        // --- CORE SYSTEM INITIALIZATION ---
        function init() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                userProgress = { ...userProgress, ...parsed };
                if(!userProgress.englishApp) {
                    userProgress.englishApp = { quiz: { queue: [], currentIndex: 0, score: 0, wrongIds: [] }, flash: { knownIds: [] } };
                }
            }
            renderDashboard();
            updateDashboardStats();
            updateUserGreeting();
            EnglishApp.init();
        }

        function updateUserGreeting() {
            const nameDisplay = document.getElementById('display-user-name');
            if (nameDisplay) {
                nameDisplay.textContent = userProgress.userName || 'Ucze≈Ñ';
            }
        }

        function renderDashboard() {
            const grid = document.getElementById('content-grid'); grid.innerHTML = '';
            Object.keys(CKE_DATA).forEach(key => {
                const item = CKE_DATA[key];
                grid.innerHTML += `<div onclick="openSubjectHub('${key}')" class="bg-white dark:bg-dark-card p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-dark-border dash-card cursor-pointer relative overflow-hidden transition-all active:scale-95">
                    <div class="absolute right-0 top-0 p-4 opacity-10 text-6xl group-hover:scale-110 transition-transform">${item.icon}</div>
                    <h3 class="font-bold text-lg text-slate-800 dark:text-white">${item.subject}</h3>
                    <p class="text-xs text-slate-400 mt-1">${item.desc}</p>
                    <div class="mt-4"><span class="text-[10px] font-bold text-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-1 rounded">${item.label}</span></div>
                </div>`;
            });
        }

        function updateDashboardStats() {
            const avg = userProgress.sheetsCount > 0 ? Math.round(userProgress.totalScoreSum / userProgress.sheetsCount) : 0;
            document.getElementById('stat-avg').textContent = `${avg}%`;
            document.getElementById('stat-streak').textContent = userProgress.streak;
        }

        function openSubjectHub(key) {
            const data = CKE_DATA[key];
            activeSubjectKey = key;
            switchView('subject-hub');
            document.getElementById('hub-title').textContent = data.subject;
            document.getElementById('hub-icon').textContent = data.icon;
            document.getElementById('hub-score').textContent = `${Math.round((userProgress.scoresBySubject[key] || 0) / (userProgress.attemptsBySubject[key] || 1))}%`;
            document.getElementById('hub-count').textContent = userProgress.attemptsBySubject[key] || 0;
            const list = document.getElementById('hub-features-list'); list.innerHTML = '';
            data.features.forEach(f => {
                const btn = document.createElement('button');
                btn.className = "w-full flex items-center justify-between p-4 bg-white dark:bg-dark-card border border-slate-100 dark:border-dark-border rounded-xl shadow-sm hover:border-indigo-400 transition-all text-left active:scale-95";
                btn.innerHTML = `<div class="flex items-center gap-4"><span class="text-2xl">${f.icon}</span><div><p class="font-bold text-slate-800 dark:text-white text-sm">${f.label}</p></div></div><span class="text-indigo-600">‚ûú</span>`;
                btn.onclick = () => {
                    if(f.type === 'sheet') { switchView('sheet'); loadSheet(key); }
                    else if(f.type === 'oral') { switchView('oral'); startOralExam(key); }
                    else if(f.type === 'eng_tab') { switchView('english-app'); EnglishApp.switchTab(f.id); }
                };
                list.appendChild(btn);
            });
        }

        function switchView(id) {
            ['home','subject-hub','sheet','oral','english-app'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
        }

        function startOralExam(key) {
            const data = CKE_DATA[key];
            document.getElementById('oral-question-text').textContent = data.oral_question;
            document.getElementById('oral-phase-1').classList.remove('hidden');
            document.getElementById('oral-phase-2').classList.add('hidden');
            document.getElementById('oral-phase-3').classList.add('hidden');
        }
        let isRecording = false;
        function toggleRecording() {
            const timer = document.getElementById('rec-timer');
            const wave = document.getElementById('wave-container');
            const btn = document.getElementById('mic-btn');
            if(!isRecording) {
                isRecording = true;
                btn.classList.replace('bg-red-500', 'bg-slate-800');
                timer.classList.remove('hidden'); wave.classList.remove('hidden');
                let s = 0; timerInterval = setInterval(() => { s++; timer.textContent = `${s}s`; }, 1000);
            } else {
                isRecording = false;
                clearInterval(timerInterval);
                document.getElementById('oral-phase-1').classList.add('hidden');
                document.getElementById('oral-phase-2').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('oral-phase-2').classList.add('hidden');
                    document.getElementById('oral-phase-3').classList.remove('hidden');
                    const list = document.getElementById('oral-checklist'); list.innerHTML = '';
                    CKE_DATA[activeSubjectKey].oral_criteria.forEach(c => {
                        list.innerHTML += `<div class="flex gap-3 p-3 bg-white dark:bg-dark-card rounded-lg border border-slate-100 dark:border-dark-border"><input type="checkbox" onchange="updateOralScore()" class="mt-1 w-5 h-5 text-indigo-600"><label class="text-xs text-slate-700 dark:text-slate-300 font-medium">${c}</label></div>`;
                    });
                }, 1500);
            }
        }
        function updateOralScore() {
            const checks = document.getElementById('oral-checklist').querySelectorAll('input:checked').length;
            currentOralScore = Math.round((checks / CKE_DATA[activeSubjectKey].oral_criteria.length) * 100);
            document.getElementById('oral-score-display').textContent = `${currentOralScore}%`;
        }
        function finishOral() { updateGlobalStats(currentOralScore, activeSubjectKey); backToHub(); }

        function loadSheet(key) {
            const data = CKE_DATA[key];
            document.getElementById('sheet-title').textContent = data.subject;
            document.getElementById('source-content').innerHTML = data.source;
            const qList = document.getElementById('questions-list'); qList.innerHTML = '';
            sessionStats = { correct: 0, total: data.tasks.length };
            data.tasks.forEach(t => {
                let opts = '';
                t.options.forEach((o, i) => opts += `<button onclick="checkSheetAns(this, ${i}, ${t.correct})" class="w-full text-left p-3 border dark:border-slate-700 rounded-lg mt-2 text-sm dark:text-white transition-colors">${o}</button>`);
                qList.innerHTML += `<div class="bg-white dark:bg-dark-card p-5 rounded-xl border border-slate-200 dark:border-dark-border shadow-sm"><h4 class="font-bold mb-3 dark:text-white text-sm">${t.question}</h4>${opts}</div>`;
            });
            startTimer();
            if(window.MathJax) window.MathJax.typeset();
        }
        function checkSheetAns(btn, idx, correct) {
            if(btn.parentElement.dataset.done) return;
            btn.parentElement.dataset.done = true;
            if(idx === correct) { btn.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/20'); sessionStats.correct++; }
            else btn.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
        }
        function finishSheet() {
            const score = Math.round((sessionStats.correct/sessionStats.total)*100);
            updateGlobalStats(score, activeSubjectKey);
            document.getElementById('final-score').textContent = `${sessionStats.correct}/${sessionStats.total}`;
            document.getElementById('final-time').textContent = document.getElementById('timer').textContent;
            document.getElementById('summary-modal').classList.remove('hidden');
        }

        function updateGlobalStats(score, key) {
            userProgress.totalScoreSum += score;
            userProgress.sheetsCount++;
            userProgress.scoresBySubject[key] = (userProgress.scoresBySubject[key] || 0) + score;
            userProgress.attemptsBySubject[key] = (userProgress.attemptsBySubject[key] || 0) + 1;
            saveState(); updateDashboardStats();
        }
        function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(userProgress)); }
        function goHome() { switchView('home'); stopTimer(); updateDashboardStats(); }
        function backToHub() { openSubjectHub(activeSubjectKey); stopTimer(); }
        function closeSummary() { document.getElementById('summary-modal').classList.add('hidden'); backToHub(); }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }
        function startTimer() { let s = 0; if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => { s++; document.getElementById('timer').textContent = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }, 1000); }
        function stopTimer() { clearInterval(timerInterval); }
        
        // Zabezpieczony globalny reset bazy
        function resetAllData() {
            ConfirmModal.show(
                "Reset aplikacji", 
                "Na pewno chcesz usunƒÖƒá WSZYSTKIE postƒôpy z ca≈Çego systemu?", 
                () => {
                    localStorage.removeItem(STORAGE_KEY);
                    userProgress = { 
                        totalScoreSum: 0, sheetsCount: 0, scoresBySubject: {}, attemptsBySubject: {}, streak: 1, 
                        lastLogin: new Date().toDateString(), userName: 'Adepcie', 
                        englishApp: { quiz: { queue: [], currentIndex: 0, score: 0, wrongIds: [] }, flash: { knownIds: [] } }
                    };
                    renderDashboard();
                    updateDashboardStats();
                    updateUserGreeting();
                    EnglishApp.updateFlashStats();
                    goHome();
                }
            );
        }

        init();
    </script>
</body>

</html>

