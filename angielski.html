<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matura English Prep - v5.1 (Grammar+)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* Animations */
        .card-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .correct-anim { animation: pulseGreen 0.4s; }
        .wrong-anim { animation: shake 0.3s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .pop-in { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .fade-out { animation: fadeOut 0.3s forwards; }
        @keyframes fadeOut { to { opacity: 0; transform: scale(0.9); } }

        /* Flip Card Styles */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* Utilities */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Grids */
        .match-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        
        /* Grammar Blocks */
        .g-block { padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; display: inline-block; margin-right: 4px; margin-bottom: 4px; }
        .gb-subject { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; } /* Blue - Podmiot */
        .gb-verb { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } /* Red - Czasownik */
        .gb-object { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; } /* Green - Reszta */
        .gb-extra { background-color: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; } /* Gray - Operator/Inne */
        .gb-op { background-color: #fff7ed; color: #9a3412; border: 1px solid #ffedd5; } /* Orange - Operator */
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden bg-slate-50">

    <!-- Header -->
    <header class="bg-white shadow-sm z-20 flex-none border-b border-slate-100">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div onclick="resetProgress()" class="cursor-pointer">
                <h1 class="text-lg font-bold text-indigo-600 tracking-tight">English Prep <span class="text-xs font-normal text-indigo-300">v5.1</span></h1>
                <p class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">Matura Podstawowa</p>
            </div>
            <div id="header-stats-container" class="text-right">
                <span id="header-label" class="text-xs font-medium text-slate-400 bg-slate-100 px-2 py-1 rounded-full">Menu</span>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-hidden relative w-full max-w-md mx-auto">
        
        <!-- === VIEW: QUIZ === -->
        <div id="view-quiz" class="absolute inset-0 overflow-y-auto p-4 flex flex-col pb-24 transition-opacity duration-300 hidden opacity-0">
            <div id="start-screen" class="w-full text-center mt-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6">
                    <div class="text-5xl mb-4">üìù</div>
                    <h2 class="text-xl font-bold mb-2 text-slate-800">Trening Maturalny</h2>
                    <p class="text-slate-500 mb-6 text-sm">RozwiƒÖ≈º testy A/B/C. System zapamiƒôtuje b≈Çƒôdy.</p>
                    <div id="resume-section" class="hidden mb-4">
                        <button onclick="resumeQuiz()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-xl font-semibold shadow-lg shadow-indigo-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                            <span>‚ñ∂Ô∏è</span> Wzn√≥w sesjƒô
                        </button>
                    </div>
                    <button onclick="startNewQuiz()" class="w-full bg-white text-indigo-600 border border-indigo-100 py-3.5 rounded-xl font-semibold hover:bg-indigo-50 active:scale-95 transition-all mb-3">Nowy Test</button>
                    <div id="error-review-section" class="hidden mt-4 pt-4 border-t border-slate-100">
                        <p class="text-sm text-red-500 font-medium mb-2">B≈Çƒôdy do poprawy: <span id="error-count">0</span></p>
                        <button onclick="startErrorReview()" class="w-full bg-red-50 text-red-600 border border-red-100 py-3 rounded-xl font-semibold hover:bg-red-100 active:scale-95 transition-all">üíä Popraw b≈Çƒôdy</button>
                    </div>
                </div>
            </div>

            <div id="quiz-container" class="w-full hidden">
                <div id="question-card" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-4 card-enter">
                    <div class="flex justify-between items-center mb-4">
                        <span id="category-tag" class="bg-indigo-50 text-indigo-600 text-[10px] px-2.5 py-1 rounded-full font-bold uppercase tracking-wider">Kategoria</span>
                        <span id="q-counter" class="text-xs font-mono text-slate-300">1/10</span>
                    </div>
                    <h3 id="question-text" class="text-lg font-medium leading-snug mb-4 text-slate-800">...</h3>
                    <div id="context-box" class="bg-slate-50 p-3 rounded-lg border-l-4 border-indigo-400 mb-5 hidden">
                        <p id="context-text" class="text-sm text-slate-600 italic"></p>
                    </div>
                    <div id="options-container" class="space-y-2.5"></div>
                </div>
                <div id="explanation-card" class="hidden bg-slate-800 text-white p-5 rounded-xl shadow-lg mt-2 card-enter mb-6">
                    <p id="explanation-text" class="text-sm text-slate-300 leading-relaxed"></p>
                    <button onclick="nextQuestion()" class="mt-4 w-full bg-white text-slate-900 py-3 rounded-lg font-bold text-sm hover:bg-slate-100 transition-colors shadow-md active:scale-95">Dalej ‚Üí</button>
                </div>
            </div>

            <div id="results-screen" class="w-full hidden text-center mt-8">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-2xl font-bold mb-2">Wynik sesji</h2>
                    <div class="flex justify-center items-baseline gap-2 mb-6">
                        <span class="text-6xl font-black text-indigo-600 tracking-tighter" id="final-score">0</span>
                    </div>
                    <button onclick="startNewQuiz()" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-semibold shadow-lg active:scale-95 transition-transform mb-3">Nowy Test</button>
                </div>
            </div>
        </div>

        <!-- === VIEW: SCRAMBLE === -->
        <div id="view-scramble" class="absolute inset-0 overflow-y-auto p-4 flex flex-col pb-24 transition-opacity duration-300 hidden opacity-0">
             <div id="scramble-start" class="w-full text-center mt-4">
                 <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6">
                    <div class="text-5xl mb-4">üß©</div>
                    <h2 class="text-xl font-bold mb-2 text-slate-800">Uk≈Çadanka Zda≈Ñ</h2>
                    <p class="text-slate-500 mb-6 text-sm">U≈Ç√≥≈º s≈Çowa w poprawnej kolejno≈õci.</p>
                    <button onclick="startScramble()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3.5 rounded-xl font-semibold shadow-lg shadow-purple-200 active:scale-95 transition-all">Start</button>
                 </div>
            </div>
            <div id="scramble-game" class="hidden w-full h-full flex flex-col">
                <div class="flex justify-between items-center mb-6">
                     <span class="text-xs font-bold text-slate-400 uppercase">Gramatyka</span>
                     <span id="scramble-counter" class="text-xs font-mono text-purple-600 font-bold">1/5</span>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 min-h-[120px] mb-4 flex flex-wrap gap-2 content-start transition-colors" id="scramble-dropzone">
                    <span class="text-slate-300 text-sm w-full text-center mt-8 pointer-events-none italic">Tutaj u≈Ç√≥≈º zdanie...</span>
                </div>
                <p id="scramble-translation" class="text-sm text-slate-500 italic text-center mb-6 min-h-[20px]">...</p>
                <div id="scramble-bank" class="flex flex-wrap gap-2 justify-center"></div>
                <div class="mt-auto pb-4">
                     <button onclick="checkScramble()" id="scramble-check-btn" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-all">Sprawd≈∫</button>
                     <div id="scramble-feedback" class="hidden mt-4 text-center p-3 rounded-lg font-bold"></div>
                     <button onclick="nextScramble()" id="scramble-next-btn" class="hidden w-full mt-4 bg-purple-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-all">Nastƒôpne</button>
                </div>
            </div>
        </div>

        <!-- === VIEW: MEMORY === -->
        <div id="view-memory" class="absolute inset-0 overflow-y-auto p-4 flex flex-col pb-24 transition-opacity duration-300 hidden opacity-0">
            <div id="memory-start" class="w-full text-center mt-4">
                 <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6">
                    <div class="text-5xl mb-4">‚ö°</div>
                    <h2 class="text-xl font-bold mb-2 text-slate-800">Szybkie Pary</h2>
                    <p class="text-slate-500 mb-6 text-sm">Wszystkie karty sƒÖ odkryte. ≈ÅƒÖcz pary (PL + EN) jak najszybciej!</p>
                    <button onclick="startMemory()" class="w-full bg-pink-500 hover:bg-pink-600 text-white py-3.5 rounded-xl font-semibold shadow-lg shadow-pink-200 active:scale-95 transition-all">Graj</button>
                 </div>
            </div>
            <div id="memory-game" class="hidden w-full">
                <div class="flex justify-between items-center mb-4">
                     <span class="text-xs font-bold text-slate-400 uppercase">Pozosta≈Ço: <span id="memory-score" class="text-pink-600 font-bold">6</span> par</span>
                     <button onclick="startMemory()" class="text-xs text-slate-400 underline">Restart</button>
                </div>
                <div id="memory-grid" class="match-grid pb-20"></div>
                <div id="memory-win" class="hidden fixed inset-0 flex items-center justify-center bg-black/50 z-50 p-4">
                    <div class="bg-white p-8 rounded-2xl shadow-xl text-center pop-in max-w-sm w-full">
                        <div class="text-5xl mb-4">üöÄ</div>
                        <h3 class="text-2xl font-bold text-slate-800 mb-2">B≈Çyskawica!</h3>
                        <p class="text-slate-500 mb-6">Plansza wyczyszczona.</p>
                        <button onclick="startMemory()" class="w-full px-6 py-3 bg-pink-600 hover:bg-pink-700 text-white rounded-xl text-sm font-bold shadow-lg">Jeszcze raz</button>
                        <button onclick="document.getElementById('memory-win').classList.add('hidden')" class="mt-3 text-xs text-slate-400">Zamknij</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VIEW: FLASHCARDS === -->
        <div id="view-flashcards" class="absolute inset-0 overflow-y-auto bg-slate-50 p-4 pb-24 hidden opacity-0 transition-opacity duration-300 flex flex-col items-center">
            <div id="flash-start" class="w-full text-center mt-4">
                 <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6">
                    <div class="text-5xl mb-4">üß†</div>
                    <h2 class="text-xl font-bold mb-2 text-slate-800">Fiszki</h2>
                    <p class="text-slate-500 mb-6 text-sm">Masz <span id="flash-total-count" class="font-bold text-indigo-600">0</span> s≈Ç√≥wek. Umiesz: <span id="flash-known-count" class="font-bold text-green-600">0</span>.</p>
                    <button onclick="startFlashcards()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3.5 rounded-xl font-semibold shadow-lg active:scale-95 transition-all">Ucz siƒô</button>
                    <button onclick="resetFlashcards()" class="mt-4 text-xs text-slate-400 underline">Zresetuj postƒôp</button>
                 </div>
            </div>
            <div id="flash-game" class="w-full hidden flex flex-col h-full max-h-[600px]">
                <div class="flex justify-between items-center mb-4 px-2">
                    <span class="text-xs font-bold text-slate-400">SESJA</span>
                    <span id="flash-counter" class="text-xs font-mono text-indigo-600 font-bold">1/10</span>
                </div>
                <div class="relative w-full h-64 perspective-1000 mb-6 group cursor-pointer" onclick="flipCard()">
                    <div id="flash-inner" class="relative w-full h-full text-center transition-transform duration-500 transform-style-3d shadow-xl rounded-2xl">
                        <div class="absolute w-full h-full bg-white border-2 border-slate-100 rounded-2xl backface-hidden flex flex-col items-center justify-center p-6">
                            <span class="text-xs text-slate-400 uppercase mb-2">English</span>
                            <h3 id="flash-front" class="text-2xl font-bold text-slate-800 leading-tight">...</h3>
                            <div class="mt-4 text-slate-300 text-xs">(Dotknij, aby obr√≥ciƒá)</div>
                        </div>
                        <div class="absolute w-full h-full bg-indigo-600 text-white rounded-2xl backface-hidden rotate-y-180 flex flex-col items-center justify-center p-6">
                            <span class="text-xs text-indigo-200 uppercase mb-2">Polski</span>
                            <h3 id="flash-back" class="text-2xl font-bold mb-3 leading-tight">...</h3>
                            <p id="flash-example" class="text-sm text-indigo-100 italic font-light">"..."</p>
                            <button onclick="event.stopPropagation(); speakFlash()" class="mt-4 p-2 bg-indigo-500 rounded-full hover:bg-indigo-400 transition">üîä</button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-auto">
                    <button onclick="rateFlashcard(false)" class="py-4 bg-red-100 text-red-700 rounded-xl font-bold shadow-sm hover:bg-red-200 active:scale-95 transition">Jeszcze nie üò¨</button>
                    <button onclick="rateFlashcard(true)" class="py-4 bg-green-100 text-green-700 rounded-xl font-bold shadow-sm hover:bg-green-200 active:scale-95 transition">Ju≈º umiem üòé</button>
                </div>
            </div>
            <div id="flash-done" class="hidden w-full text-center mt-10">
                 <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                    <div class="text-5xl mb-4">üåü</div>
                    <h2 class="text-xl font-bold mb-2">Koniec fiszek!</h2>
                    <button onclick="startFlashcards()" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-semibold shadow-lg active:scale-95 transition-all">Powt√≥rz</button>
                 </div>
            </div>
        </div>

        <!-- === VIEW: VOCAB === -->
        <div id="view-vocab" class="absolute inset-0 overflow-y-auto bg-slate-50 p-4 pb-24 hidden opacity-0 transition-opacity duration-300">
            <div class="sticky top-0 bg-slate-50 pt-2 pb-4 z-10">
                <div class="relative">
                    <input type="text" id="vocab-search" placeholder="Szukaj s≈Ç√≥wka..." onkeyup="filterVocab()" class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none text-sm transition-all shadow-sm">
                    <span class="absolute left-3 top-3 text-slate-400">üîç</span>
                </div>
            </div>
            <div id="vocab-list" class="space-y-3"></div>
        </div>

        <!-- === VIEW: GRAMMAR (NEW) === -->
        <div id="view-grammar" class="absolute inset-0 overflow-y-auto bg-slate-50 p-4 pb-24 hidden opacity-0 transition-opacity duration-300">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6 text-center">
                <div class="text-5xl mb-4">üìö</div>
                <h2 class="text-xl font-bold mb-2 text-slate-800">Gramatyka w Pigu≈Çce</h2>
                <p class="text-slate-500 text-sm">Zrozum logikƒô, a przestaniesz "strzelaƒá".</p>
                <div class="mt-4 flex flex-wrap justify-center gap-2 text-[10px] uppercase font-bold text-slate-400">
                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded">Podmiot</span>
                    <span class="px-2 py-1 bg-red-100 text-red-700 rounded">Czasownik</span>
                    <span class="px-2 py-1 bg-orange-50 text-orange-700 border border-orange-200 rounded">Operator</span>
                </div>
            </div>
            <div id="grammar-list" class="space-y-4">
                <!-- Grammar cards injected here -->
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 pb-safe z-30 shadow-[0_-5px_15px_rgba(0,0,0,0.02)] overflow-x-auto no-scrollbar">
        <div class="min-w-full flex justify-between items-center h-16 px-2">
            <button onclick="switchTab('quiz')" id="nav-quiz" class="min-w-[60px] flex-1 flex flex-col items-center justify-center text-indigo-600 transition-colors">
                <span class="text-xl mb-0.5">üìù</span>
                <span class="text-[9px] font-bold uppercase tracking-wide">Quiz</span>
            </button>
            <button onclick="switchTab('scramble')" id="nav-scramble" class="min-w-[60px] flex-1 flex flex-col items-center justify-center text-slate-400 hover:text-purple-600 transition-colors">
                <span class="text-xl mb-0.5">üß©</span>
                <span class="text-[9px] font-bold uppercase tracking-wide">Zdania</span>
            </button>
            <button onclick="switchTab('memory')" id="nav-memory" class="min-w-[60px] flex-1 flex flex-col items-center justify-center text-slate-400 hover:text-pink-500 transition-colors">
                <span class="text-xl mb-0.5">‚ö°</span>
                <span class="text-[9px] font-bold uppercase tracking-wide">Pary</span>
            </button>
            <button onclick="switchTab('flashcards')" id="nav-flashcards" class="min-w-[60px] flex-1 flex flex-col items-center justify-center text-slate-400 hover:text-indigo-500 transition-colors">
                <span class="text-xl mb-0.5">üß†</span>
                <span class="text-[9px] font-bold uppercase tracking-wide">Fiszki</span>
            </button>
            <button onclick="switchTab('vocab')" id="nav-vocab" class="min-w-[60px] flex-1 flex flex-col items-center justify-center text-slate-400 hover:text-indigo-500 transition-colors">
                <span class="text-xl mb-0.5">üìñ</span>
                <span class="text-[9px] font-bold uppercase tracking-wide">S≈Çownik</span>
            </button>
            <button onclick="switchTab('grammar')" id="nav-grammar" class="min-w-[60px] flex-1 flex flex-col items-center justify-center text-slate-400 hover:text-teal-600 transition-colors">
                <span class="text-xl mb-0.5">üéì</span>
                <span class="text-[9px] font-bold uppercase tracking-wide">Teoria</span>
            </button>
        </div>
    </nav>

    <script>
        // --- DATA ---
        const vocabularyData = [
            { id: 'v1', en: "do household chores", pl: "wykonywaƒá prace domowe", ex: "I hate doing household chores." },
            { id: 'v2', en: "tidy up", pl: "sprzƒÖtaƒá", ex: "This room needs tidying up." },
            { id: 'v3', en: "rent", pl: "wynajƒÖƒá (jako lokator)", ex: "I want to rent a flat." },
            { id: 'v4', en: "let", pl: "wynajƒÖƒá (komu≈õ)", ex: "He lets his flat to students." },
            { id: 'v5', en: "breathtaking view", pl: "zapierajƒÖcy dech widok", ex: "A room with a breathtaking view." },
            { id: 'v6', en: "get used to (+ing)", pl: "przyzwyczaiƒá siƒô do", ex: "I can't get used to getting up early." },
            { id: 'v7', en: "be used to (+ing)", pl: "byƒá przyzwyczajonym do", ex: "I am used to noise." },
            { id: 'v8', en: "put somebody up", pl: "przenocowaƒá kogo≈õ", ex: "Can you put me up for tonight?" },
            { id: 'v9', en: "can't stand", pl: "nie m√≥c znie≈õƒá", ex: "I can't stand working here." },
            { id: 'v10', en: "make somebody do", pl: "zmuszaƒá kogo≈õ do", ex: "He made me cry." },
            { id: 'v11', en: "be made to do", pl: "byƒá zmuszonym do", ex: "I was made to tidy up." },
            { id: 'v12', en: "I'd rather not", pl: "wola≈Çbym nie", ex: "Do you want to go? I'd rather not." },
            { id: 'v13', en: "try on", pl: "przymierzyƒá (ubranie)", ex: "You should try it on." },
            { id: 'v14', en: "be into something", pl: "interesowaƒá siƒô / lubiƒá", ex: "I'm not into dancing." },
            { id: 'v15', en: "keen on", pl: "bardzo lubiƒá / zapalony do", ex: "I'm keen on sports." },
            { id: 'v16', en: "fed up with", pl: "mieƒá do≈õƒá czego≈õ", ex: "I'm fed up with your lies." },
            { id: 'v17', en: "give up (+ing)", pl: "rzuciƒá / poddaƒá siƒô", ex: "I gave up smoking." },
            { id: 'v18', en: "go with", pl: "pasowaƒá (do czego≈õ)", ex: "This bag goes with your shoes." },
            { id: 'v19', en: "take after", pl: "odziedziczyƒá cechy", ex: "You take after your father." },
            { id: 'v20', en: "out of order", pl: "zepsuty (maszyna)", ex: "The lift is out of order." },
            { id: 'v21', en: "boiling", pl: "upalny / wrzƒÖcy", ex: "It's boiling outside." },
            { id: 'v22', en: "likely to", pl: "prawdopodobny", ex: "It's likely to rain." },
            { id: 'v23', en: "go abroad", pl: "wyjechaƒá za granicƒô", ex: "He has gone abroad." },
            { id: 'v24', en: "It's high time", pl: "najwy≈ºszy czas", ex: "It's high time we went home." },
            { id: 'v25', en: "If I were you", pl: "na twoim miejscu", ex: "If I were you, I would buy it." },
            { id: 'v26', en: "have something done", pl: "zleciƒá co≈õ", ex: "I must have my car repaired." }
        ];

        const grammarTopics = [
            {
                title: "Budowa Zdania (TwierdzƒÖce)",
                desc: "Z≈Çota zasada angielskiego: SVO (Subject-Verb-Object). Kto? Co robi? Co/Gdzie?",
                structure: [
                    { type: 'sub', text: "Kto? (Subject)" },
                    { type: 'verb', text: "Co robi? (Verb)" },
                    { type: 'obj', text: "Reszta (Object)" }
                ],
                examples: [
                    { en: "Tom eats pizza.", pl: "Tom je pizzƒô.", blocks: [["Tom", "sub"], ["eats", "verb"], ["pizza", "obj"]] },
                    { en: "We live in Poland.", pl: "Mieszkamy w Polsce.", blocks: [["We", "sub"], ["live", "verb"], ["in Poland", "obj"]] }
                ]
            },
            {
                title: "Pytania i Przeczenia (Operator)",
                desc: "W angielskim potrzebujesz 'pomocnika' (Operatora) do pyta≈Ñ i przecze≈Ñ. Operator bierze na siebie gramatykƒô.",
                structure: [
                    { type: 'op', text: "Operator" },
                    { type: 'sub', text: "Kto?" },
                    { type: 'verb', text: "Czasownik (Baza)" }
                ],
                examples: [
                    { en: "Do you like coffee?", pl: "Lubisz kawƒô?", blocks: [["Do", "op"], ["you", "sub"], ["like", "verb"], ["coffee?", "obj"]] },
                    { en: "He doesn't work here.", pl: "On tu nie pracuje.", blocks: [["He", "sub"], ["doesn't", "op"], ["work", "verb"], ["here", "obj"]] }
                ]
            },
            {
                title: "Present Simple (Rutyna)",
                desc: "Fakty, nawyki, rozk≈Çady jazdy. S≈Çowa klucze: always, usually, every day.",
                structure: [
                    { type: 'sub', text: "Kto" },
                    { type: 'verb', text: "Czasownik (+s dla On/Ona)" }
                ],
                examples: [
                    { en: "She drinks tea.", pl: "Ona pije herbatƒô (og√≥lnie).", blocks: [["She", "sub"], ["drinks", "verb"], ["tea", "obj"]] }
                ]
            },
            {
                title: "Present Continuous (Teraz)",
                desc: "Dzieje siƒô w tym momencie. S≈Çowa klucze: now, at the moment.",
                structure: [
                    { type: 'sub', text: "Kto" },
                    { type: 'verb', text: "am/is/are" },
                    { type: 'verb', text: "Czasownik + ING" }
                ],
                examples: [
                    { en: "She is drinking tea.", pl: "Ona pije herbatƒô (w tej chwili).", blocks: [["She", "sub"], ["is", "verb"], ["drinking", "verb"], ["tea", "obj"]] }
                ]
            },
            {
                title: "Past Simple (Przesz≈Ço≈õƒá)",
                desc: "Czynno≈õƒá zako≈Ñczona w przesz≈Ço≈õci. Daty, wczoraj. Operator: DID.",
                structure: [
                    { type: 'sub', text: "Kto" },
                    { type: 'verb', text: "2. Forma / -ed" }
                ],
                examples: [
                    { en: "I watched TV yesterday.", pl: "OglƒÖda≈Çem TV wczoraj.", blocks: [["I", "sub"], ["watched", "verb"], ["TV", "obj"], ["yesterday", "extra"]] },
                    { en: "Did you go there?", pl: "Poszed≈Çe≈õ tam?", blocks: [["Did", "op"], ["you", "sub"], ["go", "verb"], ["there?", "extra"]] }
                ]
            },
            {
                title: "Causative Have (Mieƒá co≈õ zrobione)",
                desc: "U≈ºywamy, gdy NIE robimy czego≈õ sami, ale zlecamy to komu≈õ (np. mechanikowi, fryzjerowi).",
                structure: [
                    { type: 'sub', text: "Podmiot" },
                    { type: 'verb', text: "Have" },
                    { type: 'obj', text: "Co≈õ" },
                    { type: 'verb', text: "3. Forma" }
                ],
                examples: [
                    { en: "I have my car repaired.", pl: "Naprawiam samoch√≥d (u mechanika).", blocks: [["I", "sub"], ["have", "verb"], ["my car", "obj"], ["repaired", "verb"]] },
                    { en: "She had her hair cut.", pl: "Ona ≈õciƒô≈Ça w≈Çosy (u fryzjera).", blocks: [["She", "sub"], ["had", "verb"], ["her hair", "obj"], ["cut", "verb"]] }
                ]
            },
            {
                title: "Passive Voice (Strona Bierna)",
                desc: "Wa≈ºniejsza jest czynno≈õƒá lub obiekt, a nie osoba wykonujƒÖca. Czƒôste w instrukcjach i wiadomo≈õciach.",
                structure: [
                    { type: 'obj', text: "Obiekt" },
                    { type: 'verb', text: "To Be" },
                    { type: 'verb', text: "3. Forma" }
                ],
                examples: [
                    { en: "This room needs tidying up.", pl: "Ten pok√≥j wymaga sprzƒÖtania.", blocks: [["This room", "obj"], ["needs", "verb"], ["tidying up", "verb"]] },
                    { en: "Dinner is served.", pl: "Obiad jest podany.", blocks: [["Dinner", "obj"], ["is", "verb"], ["served", "verb"]] }
                ]
            },
            {
                title: "It's High Time (Najwy≈ºszy Czas)",
                desc: "Specyficzna konstrukcja. Mimo ≈ºe m√≥wimy o teraz/przysz≈Ço≈õci, u≈ºywamy czasu przesz≈Çego!",
                structure: [
                    { type: 'extra', text: "It's high time" },
                    { type: 'sub', text: "Kto≈õ" },
                    { type: 'verb', text: "Past Simple" }
                ],
                examples: [
                    { en: "It's high time we went home.", pl: "Najwy≈ºszy czas, by≈õmy poszli do domu.", blocks: [["It's high time", "extra"], ["we", "sub"], ["went", "verb"], ["home", "extra"]] }
                ]
            },
            {
                title: "2nd Conditional (Gdybanie)",
                desc: "Sytuacje hipotetyczne, ma≈Ço realne w tera≈∫niejszo≈õci. 'Gdybym by≈Ç TobƒÖ...'",
                structure: [
                    { type: 'extra', text: "If" },
                    { type: 'sub', text: "Podmiot" },
                    { type: 'verb', text: "Past Simple" },
                    { type: 'extra', text: "," },
                    { type: 'sub', text: "Podmiot" },
                    { type: 'verb', text: "Would + Czasownik" }
                ],
                examples: [
                    { en: "If I were you, I would buy it.", pl: "Na Twoim miejscu bym to kupi≈Ç.", blocks: [["If", "extra"], ["I", "sub"], ["were", "verb"], ["you", "obj"], ["I", "sub"], ["would buy", "verb"], ["it", "obj"]] }
                ]
            },
            {
                title: "Get Used To (Przyzwyczaiƒá siƒô)",
                desc: "Opisuje proces zmiany. Bardzo wa≈ºne: po 'to' ZAWSZE dajemy czasownik z ko≈Ñc√≥wkƒÖ -ING.",
                structure: [
                    { type: 'sub', text: "Podmiot" },
                    { type: 'verb', text: "Get used to" },
                    { type: 'verb', text: "Czasownik + ING" }
                ],
                examples: [
                    { en: "I can't get used to getting up early.", pl: "Nie mogƒô przywyknƒÖƒá do wstawania rano.", blocks: [["I", "sub"], ["can't get used to", "verb"], ["getting up", "verb"], ["early", "extra"]] }
                ]
            }
        ];

        const quizData = [
            { id: 1, category: "Dom", question: "Do you know anyone who likes _____ household chores?", context: "Lubi ROBIƒÜ prace domowe.", options: ["making", "to make", "doing"], correct: 2, explanation: "Z 'chores' u≈ºywamy DO. Po 'like' u≈ºywamy -ing." },
            { id: 2, category: "Dom", question: "This room needs _____ if you want to invite friends.", context: "Wymaga posprzƒÖtania (strona bierna)", options: ["tidying up", "to tidy up", "being tidied up"], correct: 0, explanation: "'It needs doing' = wymaga zrobienia." },
            { id: 3, category: "Dom", question: "I'm looking for a room to _____.", context: "Szukam pokoju do wynajƒôcia (dla siebie).", options: ["let", "rent", "borrow"], correct: 1, explanation: "Lokator chce 'rent'. W≈Ça≈õciciel 'lets'." },
            { id: 4, category: "Dom", question: "The hotel had a breathtaking _____ over the mountains.", context: "Widok na g√≥ry.", options: ["sight", "view", "look"], correct: 1, explanation: "'View' = widok krajobrazu." },
            { id: 5, category: "Gramatyka", question: "I _____ a room with five other people.", context: "Nie mog≈Çam siƒô przyzwyczaiƒá.", options: ["didn't use to share", "wasn't used to sharing", "couldn't get used to sharing"], correct: 2, explanation: "'Get used to' = proces przyzwyczajania siƒô." },
            { id: 7, category: "Phrasal", question: "My friend Betty put me up for the night.", context: "Co znaczy 'put me up'?", options: ["picked me up", "tolerated me", "let me stay"], correct: 2, explanation: "'Put someone up' = przenocowaƒá kogo≈õ." },
            { id: 9, category: "Gramatyka", question: "My brother made me tidy our room.", context: "Strona bierna: Kazano mi.", options: ["I was encouraged", "I wanted to tidy", "I was told to tidy"], correct: 2, explanation: "Make sb do sth -> Be told to do sth." },
            { id: 24, category: "Gramatyka", question: "It's high time I _____ home.", context: "Czas i≈õƒá do domu.", options: ["go", "went", "have gone"], correct: 1, explanation: "High time + Past Simple." },
            { id: 25, category: "Gramatyka", question: "If I _____ you, I would buy flowers.", context: "Na twoim miejscu.", options: ["am", "was", "were"], correct: 2, explanation: "If I WERE you." }
        ];
        
        const scrambleData = [
            { id: 's1', text: "It is high time we went home", trans: "Najwy≈ºszy czas, ≈ºeby≈õmy poszli do domu" },
            { id: 's2', text: "I must have my car repaired", trans: "Muszƒô daƒá samoch√≥d do naprawy" },
            { id: 's3', text: "If I were you I would apologize", trans: "Na twoim miejscu bym przeprosi≈Ç" },
            { id: 's4', text: "This room needs tidying up", trans: "Ten pok√≥j wymaga posprzƒÖtania" },
            { id: 's5', text: "I was told to tidy my room", trans: "Kazano mi posprzƒÖtaƒá m√≥j pok√≥j" },
            { id: 's6', text: "I am fed up with your lies", trans: "Mam dosyƒá twoich k≈Çamstw" },
            { id: 's7', text: "Can you put me up for tonight", trans: "Mo≈ºesz mnie przenocowaƒá na dzisiaj?" }
        ];

        // --- STATE & PERSISTENCE ---
        const STORAGE_KEY = 'english_prep_v5';
        let state = {
            quiz: { queue: [], currentIndex: 0, score: 0, wrongIds: [], mode: 'full' },
            flash: { knownIds: [] }
        };

        const ui = {
            views: {
                quiz: document.getElementById('view-quiz'),
                flashcards: document.getElementById('view-flashcards'),
                vocab: document.getElementById('view-vocab'),
                scramble: document.getElementById('view-scramble'),
                memory: document.getElementById('view-memory'),
                grammar: document.getElementById('view-grammar')
            },
            nav: {
                quiz: document.getElementById('nav-quiz'),
                flashcards: document.getElementById('nav-flashcards'),
                vocab: document.getElementById('nav-vocab'),
                scramble: document.getElementById('nav-scramble'),
                memory: document.getElementById('nav-memory'),
                grammar: document.getElementById('nav-grammar')
            },
            headerLabel: document.getElementById('header-label')
        };

        // --- INIT ---
        function init() {
            renderVocab(vocabularyData);
            renderGrammar();
            loadState();
            switchTab('quiz'); // Default view
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                if (state.quiz.queue.length > 0 && state.quiz.currentIndex < state.quiz.queue.length) {
                    document.getElementById('resume-section').classList.remove('hidden');
                }
            }
        }
        function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
        function resetProgress() { if(confirm("Reset?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }

        // --- NAVIGATION ---
        function switchTab(tab) {
            Object.values(ui.views).forEach(el => { el.classList.add('hidden', 'opacity-0'); });
            Object.values(ui.nav).forEach(el => { 
                el.classList.remove('text-indigo-600', 'text-purple-600', 'text-pink-600', 'text-teal-600'); 
                el.classList.add('text-slate-400'); 
            });

            ui.views[tab].classList.remove('hidden');
            requestAnimationFrame(() => ui.views[tab].classList.remove('opacity-0'));
            
            const navEl = ui.nav[tab];
            navEl.classList.remove('text-slate-400');
            
            if(tab === 'scramble') navEl.classList.add('text-purple-600');
            else if(tab === 'memory') navEl.classList.add('text-pink-500');
            else if(tab === 'grammar') navEl.classList.add('text-teal-600');
            else navEl.classList.add('text-indigo-600');

            const labels = { quiz: 'Quiz', flashcards: 'Fiszki', scramble: 'Uk≈Çadanka', memory: 'Pary', vocab: 'S≈Çownik', grammar: 'Teoria' };
            ui.headerLabel.textContent = labels[tab];
            
            if(tab === 'flashcards') updateFlashStats();
        }

        // --- GRAMMAR LOGIC (NEW) ---
        function renderGrammar() {
            const list = document.getElementById('grammar-list');
            list.innerHTML = '';
            
            grammarTopics.forEach(topic => {
                const el = document.createElement('div');
                el.className = "bg-white p-5 rounded-xl border border-slate-100 shadow-sm";
                
                // Build Structure HTML
                let structHtml = '';
                topic.structure.forEach(part => {
                    let c = 'gb-extra';
                    if(part.type === 'sub') c = 'gb-subject';
                    if(part.type === 'verb') c = 'gb-verb';
                    if(part.type === 'obj') c = 'gb-object';
                    if(part.type === 'op') c = 'gb-op';
                    structHtml += `<span class="g-block ${c}">${part.text}</span>`;
                });

                // Build Examples HTML
                let exHtml = '';
                topic.examples.forEach(ex => {
                    let blocksHtml = '';
                    ex.blocks.forEach(blk => {
                         let c = 'gb-extra';
                         if(blk[1] === 'sub') c = 'gb-subject';
                         if(blk[1] === 'verb') c = 'gb-verb';
                         if(blk[1] === 'obj') c = 'gb-object';
                         if(blk[1] === 'op') c = 'gb-op';
                         blocksHtml += `<span class="g-block ${c}">${blk[0]}</span>`;
                    });
                    
                    exHtml += `
                        <div class="mt-3 pt-3 border-t border-slate-50">
                            <div class="mb-1">${blocksHtml}</div>
                            <p class="text-xs text-slate-400 italic">${ex.pl}</p>
                        </div>
                    `;
                });

                el.innerHTML = `
                    <h3 class="text-lg font-bold text-slate-800 mb-1">${topic.title}</h3>
                    <p class="text-sm text-slate-500 mb-3 leading-snug">${topic.desc}</p>
                    <div class="mb-2 text-xs uppercase font-bold text-slate-300">Konstrukcja:</div>
                    <div class="mb-1">${structHtml}</div>
                    ${exHtml}
                `;
                list.appendChild(el);
            });
        }

        // --- SCRAMBLE LOGIC ---
        let scrambleState = { current: 0, words: [], userOrder: [] };
        
        function startScramble() {
            scrambleState.current = 0;
            document.getElementById('scramble-start').classList.add('hidden');
            document.getElementById('scramble-game').classList.remove('hidden');
            loadScrambleLevel();
        }

        function loadScrambleLevel() {
            const data = scrambleData[scrambleState.current];
            document.getElementById('scramble-counter').textContent = `${scrambleState.current + 1}/${scrambleData.length}`;
            document.getElementById('scramble-translation').textContent = data.trans;
            document.getElementById('scramble-feedback').classList.add('hidden');
            document.getElementById('scramble-next-btn').classList.add('hidden');
            document.getElementById('scramble-check-btn').classList.remove('hidden');
            document.getElementById('scramble-dropzone').classList.remove('bg-green-50', 'bg-red-50', 'border-green-200', 'border-red-200');
            
            const bank = document.getElementById('scramble-bank');
            const drop = document.getElementById('scramble-dropzone');
            bank.innerHTML = '';
            drop.innerHTML = '<span class="text-slate-300 text-sm w-full text-center mt-8 pointer-events-none italic" id="scramble-placeholder">Kliknij s≈Çowa w odpowiedniej kolejno≈õci...</span>';
            
            const words = data.text.split(' ').sort(() => Math.random() - 0.5);
            words.forEach(word => {
                const btn = document.createElement('button');
                btn.className = "px-4 py-2 bg-white border border-slate-200 rounded-full shadow-sm font-medium text-slate-700 active:scale-95 transition-transform pop-in";
                btn.textContent = word;
                btn.onclick = () => moveWord(btn);
                bank.appendChild(btn);
            });
        }

        function moveWord(btn) {
            const bank = document.getElementById('scramble-bank');
            const drop = document.getElementById('scramble-dropzone');
            const placeholder = document.getElementById('scramble-placeholder');
            if(placeholder) placeholder.remove();

            if (btn.parentElement === bank) {
                drop.appendChild(btn);
                btn.classList.add('bg-purple-50', 'text-purple-700', 'border-purple-200');
            } else {
                bank.appendChild(btn);
                btn.classList.remove('bg-purple-50', 'text-purple-700', 'border-purple-200');
            }
        }

        function checkScramble() {
            const drop = document.getElementById('scramble-dropzone');
            const userSentence = Array.from(drop.children).map(btn => btn.textContent).join(' ');
            const correctSentence = scrambleData[scrambleState.current].text;
            const feedback = document.getElementById('scramble-feedback');

            if (userSentence === correctSentence) {
                feedback.textContent = "≈öwietnie! üéâ";
                feedback.className = "mt-4 text-center p-3 rounded-lg font-bold bg-green-100 text-green-700 block pop-in";
                drop.classList.add('bg-green-50', 'border-green-200');
                document.getElementById('scramble-check-btn').classList.add('hidden');
                document.getElementById('scramble-next-btn').classList.remove('hidden');
            } else {
                feedback.textContent = "Spr√≥buj jeszcze raz...";
                feedback.className = "mt-4 text-center p-3 rounded-lg font-bold bg-red-100 text-red-700 block wrong-anim";
            }
        }

        function nextScramble() {
            scrambleState.current++;
            if(scrambleState.current < scrambleData.length) loadScrambleLevel();
            else { alert("Koniec uk≈Çadanki! Mistrz gramatyki."); switchTab('quiz'); }
        }

        // --- SPEED MATCH LOGIC ---
        let matchState = { selected: null, matchesLeft: 6 };
        
        function startMemory() {
            document.getElementById('memory-start').classList.add('hidden');
            document.getElementById('memory-game').classList.remove('hidden');
            document.getElementById('memory-win').classList.add('hidden');
            matchState = { selected: null, matchesLeft: 6 };
            document.getElementById('memory-score').textContent = matchState.matchesLeft;
            
            const subset = [...vocabularyData].sort(() => Math.random() - 0.5).slice(0, 6);
            let cards = [];
            subset.forEach(item => {
                cards.push({ id: item.id, text: item.en, type: 'en' });
                cards.push({ id: item.id, text: item.pl, type: 'pl' });
            });
            cards.sort(() => Math.random() - 0.5);

            const grid = document.getElementById('memory-grid');
            grid.innerHTML = '';

            cards.forEach(card => {
                const el = document.createElement('div');
                el.className = "bg-white border-2 border-slate-200 rounded-xl p-3 flex items-center justify-center text-center text-xs font-bold text-slate-700 cursor-pointer shadow-sm active:scale-95 transition-all min-h-[80px] break-words";
                el.textContent = card.text;
                el.dataset.id = card.id;
                el.onclick = () => handleMatchClick(el);
                grid.appendChild(el);
            });
        }

        function handleMatchClick(el) {
            if(el.classList.contains('fade-out') || el.classList.contains('matched')) return;
            if(matchState.selected === el) {
                el.classList.remove('border-pink-500', 'bg-pink-50', 'text-pink-700');
                matchState.selected = null;
                return;
            }
            el.classList.add('border-pink-500', 'bg-pink-50', 'text-pink-700');

            if(!matchState.selected) {
                matchState.selected = el;
            } else {
                const prev = matchState.selected;
                if(prev.dataset.id === el.dataset.id) {
                    prev.classList.replace('border-pink-500', 'border-green-500');
                    prev.classList.replace('bg-pink-50', 'bg-green-100');
                    prev.classList.replace('text-pink-700', 'text-green-800');
                    prev.classList.add('matched', 'fade-out');

                    el.classList.replace('border-pink-500', 'border-green-500');
                    el.classList.replace('bg-pink-50', 'bg-green-100');
                    el.classList.replace('text-pink-700', 'text-green-800');
                    el.classList.add('matched', 'fade-out');

                    matchState.matchesLeft--;
                    document.getElementById('memory-score').textContent = matchState.matchesLeft;

                    if(matchState.matchesLeft === 0) {
                        setTimeout(() => document.getElementById('memory-win').classList.remove('hidden'), 500);
                    }
                } else {
                    el.classList.add('wrong-anim', 'border-red-400', 'bg-red-50');
                    prev.classList.add('wrong-anim', 'border-red-400', 'bg-red-50');
                    setTimeout(() => {
                        el.classList.remove('wrong-anim', 'border-red-400', 'bg-red-50', 'border-pink-500', 'bg-pink-50', 'text-pink-700');
                        prev.classList.remove('wrong-anim', 'border-red-400', 'bg-red-50', 'border-pink-500', 'bg-pink-50', 'text-pink-700');
                    }, 400);
                }
                matchState.selected = null;
            }
        }

        // --- FLASHCARDS LOGIC ---
        let flashQueue = [];
        let flashIndex = 0;
        let isFlipped = false;

        function updateFlashStats() {
            document.getElementById('flash-total-count').textContent = vocabularyData.length;
            document.getElementById('flash-known-count').textContent = state.flash.knownIds.length;
        }

        function startFlashcards() {
            const unknown = vocabularyData.filter(w => !state.flash.knownIds.includes(w.id));
            flashQueue = unknown.length > 0 ? shuffleArray([...unknown]) : shuffleArray([...vocabularyData]);
            flashIndex = 0;
            isFlipped = false;
            document.getElementById('flash-start').classList.add('hidden');
            document.getElementById('flash-done').classList.add('hidden');
            document.getElementById('flash-game').classList.remove('hidden');
            loadFlashCard();
        }

        function loadFlashCard() {
            const card = flashQueue[flashIndex];
            isFlipped = false;
            const inner = document.getElementById('flash-inner');
            inner.classList.remove('rotate-y-180');
            document.getElementById('flash-front').textContent = card.en;
            document.getElementById('flash-back').textContent = card.pl;
            document.getElementById('flash-example').textContent = `"${card.ex}"`;
            document.getElementById('flash-counter').textContent = `${flashIndex + 1} / ${flashQueue.length}`;
        }

        function flipCard() {
            isFlipped = !isFlipped;
            const inner = document.getElementById('flash-inner');
            if(isFlipped) inner.classList.add('rotate-y-180'); else inner.classList.remove('rotate-y-180');
        }

        function rateFlashcard(known) {
            if(known) {
                if(!state.flash.knownIds.includes(flashQueue[flashIndex].id)) state.flash.knownIds.push(flashQueue[flashIndex].id);
            }
            saveState();
            flashIndex++;
            if(flashIndex < flashQueue.length) setTimeout(loadFlashCard, 200);
            else {
                document.getElementById('flash-game').classList.add('hidden');
                document.getElementById('flash-done').classList.remove('hidden');
                updateFlashStats();
            }
        }
        function resetFlashcards() { if(confirm("Reset?")) { state.flash.knownIds = []; saveState(); updateFlashStats(); } }
        function speakFlash() { speak(flashQueue[flashIndex].en); }

        // --- QUIZ LOGIC ---
        function shuffleArray(arr) { return arr.sort(() => Math.random() - 0.5); }
        function startNewQuiz() {
            state.quiz.queue = shuffleArray(quizData.map(q => q.id));
            state.quiz.currentIndex = 0; state.quiz.score = 0;
            runQuizSetup();
        }
        function resumeQuiz() { runQuizSetup(); }
        function startErrorReview() {
            state.quiz.queue = shuffleArray([...state.quiz.wrongIds]);
            state.quiz.currentIndex = 0; state.quiz.score = 0; state.quiz.wrongIds = [];
            saveState(); runQuizSetup();
        }
        function runQuizSetup() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            loadQuestion(); saveState();
        }
        function loadQuestion() {
            const qId = state.quiz.queue[state.quiz.currentIndex];
            const data = quizData.find(q => q.id === qId);
            document.getElementById('explanation-card').classList.add('hidden');
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('category-tag').textContent = data.category;
            document.getElementById('question-text').textContent = data.question;
            document.getElementById('q-counter').textContent = `${state.quiz.currentIndex + 1}/${state.quiz.queue.length}`;
            if(data.context) {
                document.getElementById('context-box').classList.remove('hidden');
                document.getElementById('context-text').textContent = data.context;
            } else document.getElementById('context-box').classList.add('hidden');
            
            data.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl border-2 border-slate-100 bg-white hover:border-indigo-200 hover:bg-indigo-50 transition-all font-medium text-slate-700 text-sm active:scale-98 shadow-sm";
                btn.textContent = opt;
                btn.onclick = () => checkQuizAns(idx, btn, data);
                document.getElementById('options-container').appendChild(btn);
            });
        }
        function checkQuizAns(idx, btn, data) {
            const btns = document.getElementById('options-container').querySelectorAll('button');
            btns.forEach(b => b.disabled = true);
            if(idx === data.correct) {
                state.quiz.score++;
                btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'correct-anim', 'border-transparent');
            } else {
                btn.classList.add('bg-red-100', 'border-red-500', 'text-red-800', 'wrong-anim', 'border-transparent');
                btns[data.correct].classList.add('bg-green-50', 'border-green-400', 'text-green-700');
                if(!state.quiz.wrongIds.includes(data.id)) state.quiz.wrongIds.push(data.id);
            }
            saveState();
            document.getElementById('explanation-text').textContent = data.explanation;
            document.getElementById('explanation-card').classList.remove('hidden');
            setTimeout(() => document.getElementById('explanation-card').scrollIntoView({ behavior: 'smooth', block: 'end' }), 100);
        }
        function nextQuestion() {
            state.quiz.currentIndex++;
            saveState();
            if(state.quiz.currentIndex < state.quiz.queue.length) { loadQuestion(); document.getElementById('view-quiz').scrollTo(0,0); }
            else {
                document.getElementById('quiz-container').classList.add('hidden');
                document.getElementById('results-screen').classList.remove('hidden');
                document.getElementById('final-score').textContent = state.quiz.score;
            }
        }

        // --- VOCAB ---
        function renderVocab(data) {
            const list = document.getElementById('vocab-list');
            list.innerHTML = '';
            data.forEach(item => {
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col gap-1';
                el.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="text-indigo-700 font-bold text-lg">${item.en}</span>
                        <button onclick="speak('${item.en.replace(/'/g, "\\'")}')" class="text-slate-400 hover:text-indigo-500 p-1">üîä</button>
                    </div>
                    <span class="text-slate-800 font-medium border-b border-indigo-50 pb-1 mb-1">${item.pl}</span>
                    <span class="text-slate-400 text-xs italic">"${item.ex}"</span>
                `;
                list.appendChild(el);
            });
        }
        function filterVocab() {
            const q = document.getElementById('vocab-search').value.toLowerCase();
            renderVocab(vocabularyData.filter(i => i.en.toLowerCase().includes(q) || i.pl.toLowerCase().includes(q)));
        }
        function speak(txt) {
            const u = new SpeechSynthesisUtterance(txt); u.lang = 'en-GB'; window.speechSynthesis.speak(u);
        }

        init();
    </script>
</body>
</html>
