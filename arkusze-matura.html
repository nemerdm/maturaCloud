<!DOCTYPE html>
<html lang="pl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matura Cloud - Dynamic v8.4 (Mobile Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', card: '#1e293b', text: '#f8fafc', subtext: '#94a3b8', border: '#334155' }
                    }
                }
            }
        }
    </script>

    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .serif { font-family: 'Merriweather', serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background-color: #475569; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .pop-up { animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Layout Utilities */
        .dash-card:hover { transform: translateY(-2px); transition: transform 0.2s; }
        * { transition: background-color 0.3s, border-color 0.3s, color 0.3s; }

        /* Audio Wave Animation */
        .wave-bar { width: 6px; background-color: #6366f1; border-radius: 99px; animation: wave 1s ease-in-out infinite; }
        @keyframes wave { 0%, 100% { height: 10px; } 50% { height: 40px; } }
    </style>
</head>
<!-- UPDATED: h-[100dvh] for mobile browser address bar handling -->
<body class="bg-slate-50 text-slate-800 dark:bg-dark-bg dark:text-dark-text h-[100dvh] flex flex-col overflow-hidden transition-colors duration-300">

    <!-- HEADER (App Level) -->
    <header class="bg-white dark:bg-dark-card shadow-sm z-30 flex-none border-b border-slate-200 dark:border-dark-border">
        <div class="w-full px-4 py-3 flex justify-between items-center">
            <div onclick="goHome()" class="cursor-pointer flex items-center gap-3">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-md">M</div>
                <div>
                    <h1 class="text-sm font-bold text-slate-900 dark:text-white tracking-tight leading-none">Matura<span class="text-indigo-600 dark:text-indigo-400">Cloud</span></h1>
                    <p class="text-[10px] text-slate-400 font-medium uppercase tracking-wider mt-0.5">Ultimate</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-1 bg-orange-50 dark:bg-orange-900/20 px-2 py-1 rounded-full border border-orange-100 dark:border-orange-800/30" title="Dni nauki z rzƒôdu">
                    <span class="text-sm">üî•</span>
                    <span class="text-xs font-bold text-orange-600 dark:text-orange-400" id="stat-streak">1</span>
                </div>
                <button onclick="toggleDarkMode()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    <span id="theme-icon">üåô</span>
                </button>
                <div class="w-8 h-8 bg-indigo-100 dark:bg-indigo-900 rounded-full flex items-center justify-center text-xs font-bold text-indigo-600 dark:text-indigo-300 border-2 border-white dark:border-slate-700 shadow-sm">P</div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <main class="flex-1 overflow-hidden relative w-full h-full">
        
        <!-- DASHBOARD (Scrollable independently) -->
        <div id="view-home" class="absolute inset-0 z-20 bg-slate-50 dark:bg-dark-bg p-4 md:p-8 overflow-y-auto">
            <div class="max-w-5xl mx-auto pb-20"> <!-- Added padding bottom -->
                <div class="mb-8 flex justify-between items-end">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Witaj, Piotr! üëã</h2>
                        <p class="text-slate-500 dark:text-dark-subtext">Masz 34 dni do matury. Czas na powt√≥rkƒô.</p>
                    </div>
                    <button onclick="resetAllData()" class="text-[10px] text-slate-300 hover:text-red-400 underline">Resetuj Dane</button>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white dark:bg-dark-card p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border dash-card">
                        <p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">≈örednia</p>
                        <p class="text-2xl font-black text-indigo-600 dark:text-indigo-400" id="stat-avg">0%</p>
                    </div>
                    <div id="adaptive-card" class="col-span-2 bg-gradient-to-r from-slate-700 to-slate-800 p-4 rounded-2xl shadow-lg text-white flex justify-between items-center dash-card relative overflow-hidden">
                        <div class="relative z-10 w-full">
                            <div class="flex items-center gap-2 mb-1"><span class="bg-white/20 p-1 rounded text-xs">üöÄ Start</span></div>
                            <p class="font-bold text-lg" id="adaptive-title">Brak danych</p>
                            <p class="text-xs text-slate-300 mb-3" id="adaptive-desc">RozwiƒÖ≈º arkusz, aby otrzymaƒá analizƒô.</p>
                            <button id="adaptive-btn" onclick="loadSheet('matematyka')" class="bg-white text-slate-900 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-slate-100 transition-colors">Rozpocznij</button>
                        </div>
                        <div class="text-8xl opacity-10 absolute -right-4 -bottom-4">üìä</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex gap-4 mb-6 overflow-x-auto no-scrollbar pb-2">
                    <button onclick="filterContent('all')" id="tab-all" class="px-4 py-2 bg-slate-800 dark:bg-white text-white dark:text-slate-900 rounded-full text-sm font-bold shadow-md transition-colors tab-btn">Wszystkie</button>
                    <button onclick="filterContent('oral')" id="tab-oral" class="px-4 py-2 bg-white dark:bg-dark-card text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-dark-border rounded-full text-sm font-medium hover:bg-slate-50 transition-colors tab-btn">Ustne</button>
                    <button onclick="filterContent('sheet')" id="tab-sheet" class="px-4 py-2 bg-white dark:bg-dark-card text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-dark-border rounded-full text-sm font-medium hover:bg-slate-50 transition-colors tab-btn">Arkusze</button>
                </div>

                <!-- Content Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="content-grid">
                    <!-- Javascript will inject content here -->
                </div>
            </div>
        </div>

        <!-- ORAL EXAM -->
        <div id="view-oral" class="absolute inset-0 z-30 bg-white dark:bg-dark-bg hidden flex flex-col items-center justify-center p-6 text-center overflow-y-auto">
            <div class="max-w-md w-full min-h-full flex flex-col justify-center py-10">
                
                <!-- PHASE 1: QUESTION -->
                <div id="oral-phase-1">
                    <div class="mb-8">
                        <span class="bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest">Matura Ustna</span>
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-white mt-4 mb-2">Twoje Zadanie</h2>
                        <div class="bg-slate-50 dark:bg-dark-card p-6 rounded-2xl border border-slate-200 dark:border-dark-border shadow-sm text-left">
                            <p class="text-lg font-serif italic text-slate-700 dark:text-slate-300">"Motyw winy i kary w literaturze. Om√≥w zagadnienie na podstawie 'Makbeta' Williama Szekspira oraz innego wybranego utworu."</p>
                        </div>
                    </div>
                    <div id="recording-ui" class="flex flex-col items-center">
                        <div class="relative mb-8">
                            <div id="mic-pulse" class="absolute inset-0 bg-red-500 rounded-full opacity-0"></div>
                            <button onclick="toggleRecording()" id="mic-btn" class="relative z-10 w-20 h-20 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center text-3xl shadow-xl transition-transform active:scale-95 text-white">üéôÔ∏è</button>
                        </div>
                        <p id="rec-status" class="text-slate-400 text-sm font-mono mb-4">Naci≈õnij, aby rozpoczƒÖƒá odpowied≈∫</p>
                        <p id="rec-timer" class="text-4xl font-black text-slate-800 dark:text-white hidden">00:00</p>
                        <div id="wave-container" class="hidden flex gap-1 h-10 items-center justify-center mt-4">
                            <div class="wave-bar" style="animation-delay: 0s"></div>
                            <div class="wave-bar" style="animation-delay: 0.1s"></div>
                            <div class="wave-bar" style="animation-delay: 0.2s"></div>
                            <div class="wave-bar" style="animation-delay: 0.3s"></div>
                            <div class="wave-bar" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                </div>

                <!-- PHASE 2: PROCESSING (FAKE) -->
                <div id="oral-phase-2" class="hidden text-center">
                    <div class="text-6xl mb-4 animate-bounce">ü§ñ</div>
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Analizowanie wypowiedzi...</h3>
                    <p class="text-slate-500 dark:text-slate-400 text-sm">Por√≥wnywanie z kluczem egzaminacyjnym CKE.</p>
                </div>

                <!-- PHASE 3: SELF-CHECK -->
                <div id="oral-phase-3" class="hidden text-left pop-up pb-10">
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Samoocena</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">BƒÖd≈∫ uczciwy. Zaznacz punkty, kt√≥re poruszy≈Çe≈õ w swojej wypowiedzi.</p>
                    <div class="space-y-3 mb-6" id="oral-checklist"></div>
                    <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800 mb-6">
                        <p class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase mb-1">Tw√≥j Wynik:</p>
                        <p class="text-3xl font-black text-indigo-700 dark:text-indigo-300" id="oral-score-display">0%</p>
                    </div>
                    <button onclick="finishOral()" class="w-full bg-slate-900 dark:bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">Zapisz Wynik</button>
                </div>

                <button onclick="goHome()" class="mt-8 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-sm">Anuluj / Wyjd≈∫</button>
            </div>
        </div>

        <!-- SHEET VIEW (COMPLETELY REBUILT FOR MOBILE) -->
        <!-- Fixed positioning with flex column layout ensures footer is always visible -->
        <div id="view-sheet" class="fixed inset-0 z-50 bg-white dark:bg-dark-bg hidden flex flex-col h-[100dvh] w-full">
            
            <!-- 1. HEADER (Fixed Top) -->
            <div class="flex-none bg-white dark:bg-dark-card border-b border-slate-200 dark:border-dark-border px-4 py-3 flex justify-between items-center text-xs font-medium text-slate-500 shadow-sm z-20">
                <div class="flex items-center gap-3">
                    <button onclick="openExitModal()" class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 hover:bg-red-50 hover:text-red-600 dark:hover:text-red-400 transition-colors">‚úï</button>
                    <div class="flex items-center gap-2 overflow-hidden">
                        <span id="sheet-subject-tag" class="shrink-0 px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300">PREDM</span>
                        <span id="sheet-title" class="truncate font-bold text-slate-700 dark:text-slate-200 max-w-[120px] md:max-w-xs">Arkusz</span>
                    </div>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <span class="hidden md:inline text-[10px] uppercase tracking-wider text-slate-400">Czas:</span>
                    <span id="timer" class="font-mono bg-slate-100 dark:bg-slate-700 dark:text-slate-300 px-2 py-1 rounded text-slate-700">00:00</span>
                </div>
            </div>

            <!-- 2. CONTENT (Flexible Middle Area) -->
            <div class="flex-1 overflow-hidden relative w-full">
                <!-- Mobile: Flex Column (Split Screen), Desktop: Flex Row -->
                <div class="flex flex-col md:flex-row h-full w-full">
                    
                    <!-- Source Text: 35% height on mobile, full height 50% width on desktop -->
                    <div class="source-text bg-white dark:bg-dark-bg p-6 md:p-10 custom-scrollbar border-b-4 border-slate-100 md:border-b-0 md:border-r border-slate-200 dark:border-dark-border overflow-y-auto h-[35%] md:h-full md:flex-1 md:w-1/2">
                        <div class="sticky top-0 bg-white dark:bg-dark-bg z-10 pb-2 mb-2 border-b border-slate-100 dark:border-dark-border md:hidden">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Tekst ≈πr√≥d≈Çowy</span>
                        </div>
                        <div id="source-content" class="prose prose-sm md:prose-base max-w-none text-slate-700 dark:text-slate-300"></div>
                    </div>
                    
                    <!-- Questions: Remaining height (flex-1) on mobile, full height 50% width on desktop -->
                    <div class="questions-panel bg-slate-50 dark:bg-dark-card p-4 md:p-8 custom-scrollbar overflow-y-auto flex-1 md:h-full md:w-1/2">
                        <div class="flex justify-between items-center mb-4 sticky top-0 bg-slate-50 dark:bg-dark-card z-10 py-2">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Zadania</h3>
                            <span class="text-xs text-slate-400" id="progress-indicator">0/0</span>
                        </div>
                        <div id="questions-list" class="space-y-6 pb-4"></div>
                    </div>
                </div>
            </div>

            <!-- 3. FOOTER (Fixed Bottom) -->
            <div class="flex-none p-4 bg-white dark:bg-dark-card border-t border-slate-200 dark:border-dark-border z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                <button onclick="finishSheet()" class="w-full bg-slate-900 dark:bg-indigo-600 text-white py-3.5 rounded-xl font-bold text-sm hover:bg-slate-700 dark:hover:bg-indigo-500 transition-colors shadow-lg active:scale-95 flex items-center justify-center gap-2">
                    <span>Zako≈Ñcz i Sprawd≈∫</span>
                    <span>‚ûú</span>
                </button>
            </div>
        </div>

        <!-- MODALS -->
        <div id="exit-modal" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white dark:bg-dark-card w-full max-w-sm rounded-2xl shadow-2xl p-6 text-center pop-up">
                <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-full flex items-center justify-center text-2xl mx-auto mb-4">‚ö†Ô∏è</div>
                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Przerwaƒá?</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Postƒôp zostanie utracony.</p>
                <div class="flex gap-3">
                    <button onclick="closeExitModal()" class="flex-1 py-3 rounded-xl font-bold text-sm border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800">Anuluj</button>
                    <button onclick="confirmExitAction()" class="flex-1 py-3 rounded-xl font-bold text-sm bg-red-600 text-white hover:bg-red-700">Wyjd≈∫</button>
                </div>
            </div>
        </div>

        <div id="summary-modal" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white dark:bg-dark-card w-full max-w-sm rounded-3xl shadow-2xl p-8 text-center pop-up relative">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white mt-4 mb-2">Arkusz Zako≈Ñczony!</h2>
                <div class="flex justify-center gap-4 mb-8 mt-6">
                    <div class="text-center"><p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Wynik</p><p class="text-3xl font-black text-slate-800 dark:text-white" id="final-score">0/0</p></div>
                    <div class="w-px bg-slate-100 dark:bg-slate-700"></div>
                    <div class="text-center"><p class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Czas</p><p class="text-3xl font-black text-slate-800 dark:text-white" id="final-time">00:00</p></div>
                </div>
                <button onclick="closeSummary()" class="w-full bg-slate-900 dark:bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg">Wr√≥ƒá</button>
            </div>
        </div>

        <!-- AI CHAT MODAL -->
        <div id="ai-modal" class="hidden fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center p-4">
            <div class="bg-white dark:bg-dark-card w-full max-w-md h-[500px] rounded-t-2xl md:rounded-3xl shadow-2xl flex flex-col pop-up overflow-hidden">
                <div class="bg-indigo-600 p-4 flex justify-between items-center text-white">
                    <div class="flex items-center gap-3"><div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center text-lg">ü§ñ</div><h3 class="font-bold text-sm">AI Tutor</h3></div>
                    <button onclick="toggleAiChat()" class="text-white hover:bg-white/20 p-1 rounded">‚úï</button>
                </div>
                <div class="flex-1 bg-slate-50 dark:bg-dark-bg p-4 overflow-y-auto space-y-4" id="ai-chat-history">
                    <div class="flex gap-3"><div class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900 flex-none flex items-center justify-center text-xs">ü§ñ</div><div class="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border p-3 rounded-2xl rounded-tl-none text-sm text-slate-700 dark:text-slate-300 shadow-sm">Cze≈õƒá! W czym pom√≥c?</div></div>
                </div>
                <div class="p-3 bg-white dark:bg-dark-card border-t border-slate-200 dark:border-dark-border flex gap-2">
                    <input type="text" placeholder="Napisz pytanie..." class="flex-1 bg-slate-100 dark:bg-slate-800 border-0 rounded-xl px-4 text-sm dark:text-white focus:ring-2 focus:ring-indigo-500">
                    <button class="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition">‚û§</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- DATA ---
        const CKE_DATA = {
            polski: {
                id: 'polski', title: "Lalka - Analiza", subject: "Polski", theme: "red", icon: "üáµüá±",
                desc: "Lektury: Lalka, Prus", label: "CKE 2023",
                source: `<h2 class='font-bold text-2xl mb-4 text-slate-900 dark:text-white'>Lalka</h2><p class='text-slate-700 dark:text-slate-300 leading-relaxed'>Wokulski spostrzeg≈Ç, ≈ºe panna Izabela patrzy na niego z wyrazem, kt√≥rego nie m√≥g≈Ç zrozumieƒá. By≈Ço to po≈ÇƒÖczenie ciekawo≈õci z pewnƒÖ dozƒÖ wy≈ºszo≈õci. Sala balowa l≈õni≈Ça od ≈õwiate≈Ç, a muzyka zdawa≈Ça siƒô zag≈Çuszaƒá jego w≈Çasne my≈õli. <br><br> Czu≈Ç siƒô obco w tym towarzystwie, mimo swojego majƒÖtku. Jego czerwone d≈Çonie, pamiƒÖtka po latach ciƒô≈ºkiej pracy i syberyjskich mrozach, zdawa≈Çy siƒô parzyƒá go w bia≈Çych rƒôkawiczkach. Wszystko tutaj by≈Ço teatrem, a on jedynym widzem, kt√≥ry zap≈Çaci≈Ç za bilet o wiele za du≈ºo.</p>`,
                tasks: [{ id: 1, type: "radio", question: "Co jest g≈Ç√≥wnym ≈∫r√≥d≈Çem dyskomfortu Wokulskiego w tej scenie?", options: ["Wysoka temperatura w sali", "Poczucie ni≈ºszo≈õci klasowej i braki w etykiecie", "Nie≈õwie≈ºa ryba na obiedzie"], correct: 1, explanation: "Wokulski czuje siƒô gorszy ze wzglƒôdu na swoje pochodzenie kupieckie w zderzeniu z arystokracjƒÖ." }]
            },
            matematyka: {
                id: 'matematyka', title: "Funkcje", subject: "Matematyka", theme: "blue", icon: "üìê",
                desc: "Funkcje kwadratowe", label: "CKE 2024",
                source: `<h2 class='font-bold text-2xl mb-4 text-slate-900 dark:text-white'>Zadanie - Funkcja</h2><p class='text-slate-700 dark:text-slate-300'>Dana jest funkcja kwadratowa okre≈õlona wzorem:</p><p class='my-4 text-xl font-mono text-center'>$$f(x) = -x^2 + 4x + 5$$</p><p>OsiƒÖ symetrii paraboli bƒôdƒÖcej wykresem tej funkcji jest prosta o r√≥wnaniu $x = p$.</p>`,
                tasks: [{ id: 1, type: "radio", question: "Wsp√≥≈Çrzƒôdna p wierzcho≈Çka paraboli wynosi:", options: ["2", "-2", "4"], correct: 0, explanation: "Wz√≥r na $p = -b/2a$. Tutaj $p = -4 / (2 * -1) = -4 / -2 = 2$." }]
            },
            angielski: {
                id: 'angielski', title: "Reading", subject: "Angielski", theme: "indigo", icon: "üá¨üáß",
                desc: "Remote Work Analysis", label: "Pearson",
                source: `<h2 class='font-bold text-2xl mb-4 text-slate-900 dark:text-white'>Remote Work</h2><p class='text-slate-700 dark:text-slate-300'>Remote work offers flexibility but requires significant self-discipline. Employees often struggle with separating their professional and private lives when their home becomes their office. However, studies show that productivity can actually increase in a remote setting if proper boundaries are established.</p>`,
                tasks: [{ id: 1, type: "radio", question: "According to the text, successful remote work requires:", options: ["More money", "Self-discipline", "More time"], correct: 1, explanation: "The text states it 'requires significant self-discipline'." }]
            },
            chemia: {
                id: 'chemia', title: "Kwasy", subject: "Chemia", theme: "teal", icon: "üß™",
                desc: "Kwasy Tlenowe", label: "Nowy Arkusz",
                source: `<h2 class='font-bold text-2xl mb-4 text-slate-900 dark:text-white'>Otrzymywanie H2SO4</h2><p class='text-slate-700 dark:text-slate-300'>Kwas siarkowy(VI) mo≈ºna otrzymaƒá w reakcji tlenku kwasowego z wodƒÖ:</p><p class='my-4 text-xl font-mono text-center'>$$SO_3 + H_2O \\rightarrow H_2SO_4$$</p>`,
                tasks: [{ id: 1, type: "radio", question: "Kt√≥ry tlenek jest bezwodnikiem kwasu siarkowego(VI)?", options: ["SO2", "SO3"], correct: 1, explanation: "SO3 to tlenek siarki(VI), bezwodnik H2SO4." }]
            },
            biologia: {
                id: 'biologia', title: "Genetyka", subject: "Biologia", theme: "green", icon: "üß¨",
                desc: "Krzy≈º√≥wki Genetyczne", label: "Wykresy",
                source: `<h2 class='font-bold text-2xl mb-4 text-slate-900 dark:text-white'>Dziedziczenie</h2><div class='bg-slate-100 dark:bg-slate-800 p-4 rounded text-center mb-4'>Rodzice sƒÖ heterozygotami: Aa x Aa</div><p>Cecha A (ciemne oczy) dominuje nad cechƒÖ a (jasne oczy).</p>`,
                tasks: [{ id: 1, type: "radio", question: "Jakie jest prawdopodobie≈Ñstwo urodzenia dziecka o jasnych oczach (aa)?", options: ["25%", "50%", "75%"], correct: 0, explanation: "Rozk≈Çad genotyp√≥w: AA (25%), Aa (50%), aa (25%)." }]
            },
            geografia: {
                id: 'geografia', title: "Tektonika", subject: "Geografia", theme: "yellow", icon: "üåç",
                desc: "P≈Çyty Tektoniczne", label: "Mapy",
                source: `<h2 class='font-bold text-2xl mb-4 text-slate-900 dark:text-white'>Ruchy P≈Çyt</h2><p>Litosfera podzielona jest na p≈Çyty tektoniczne, kt√≥re przemieszczajƒÖ siƒô wzglƒôdem siebie. Trzƒôsienia ziemi wystƒôpujƒÖ najczƒô≈õciej na granicach tych p≈Çyt.</p>`,
                tasks: [{ id: 1, type: "radio", question: "Gdzie najczƒô≈õciej wystƒôpujƒÖ trzƒôsienia ziemi?", options: ["W ≈õrodku p≈Çyt", "Na granicach p≈Çyt"], correct: 1, explanation: "Aktywno≈õƒá sejsmiczna jest najwiƒôksza na stykach p≈Çyt litosfery." }]
            },
            // ORAL EXAM DATA
            oral_makbet: {
                question: "Motyw winy i kary w literaturze. Om√≥w zagadnienie na podstawie 'Makbeta'.",
                criteria: [
                    "Zdefiniowanie zbrodni Makbeta jako z≈Çamania praw boskich i moralnych.",
                    "Przywo≈Çanie roli Lady Makbet jako inicjatorki z≈Ça.",
                    "Wspomnienie o objawach wyrzut√≥w sumienia (omamy, lunatykowanie, krew na rƒôkach).",
                    "Kontekst innego utworu (np. Balladyna, Zbrodnia i Kara, Dziady cz. II).",
                    "Poprawno≈õƒá jƒôzykowa, styl i sp√≥jno≈õƒá wypowiedzi."
                ]
            }
        };

        // --- STATE ---
        const STORAGE_KEY = 'matura_cloud_v8_4_mobile';
        let userProgress = { totalScoreSum: 0, sheetsCount: 0, scoresBySubject: {}, attemptsBySubject: {}, streak: 1, lastLogin: new Date().toDateString() };

        // --- DOM ---
        const dom = {
            home: document.getElementById('view-home'),
            sheet: document.getElementById('view-sheet'),
            oral: document.getElementById('view-oral'),
            sourceContent: document.getElementById('source-content'),
            questionsList: document.getElementById('questions-list'),
            sheetTitle: document.getElementById('sheet-title'),
            sheetTag: document.getElementById('sheet-subject-tag'),
            timer: document.getElementById('timer'),
            progress: document.getElementById('progress-indicator'),
            summaryModal: document.getElementById('summary-modal'),
            exitModal: document.getElementById('exit-modal'),
            finalScore: document.getElementById('final-score'),
            finalTime: document.getElementById('final-time'),
            aiModal: document.getElementById('ai-modal'),
            statAvg: document.getElementById('stat-avg'),
            statStreak: document.getElementById('stat-streak'),
            adaptCard: document.getElementById('adaptive-card'),
            adaptTitle: document.getElementById('adaptive-title'),
            adaptDesc: document.getElementById('adaptive-desc'),
            adaptBtn: document.getElementById('adaptive-btn'),
            contentGrid: document.getElementById('content-grid'),
            oralChecklist: document.getElementById('oral-checklist'),
            oralScoreDisplay: document.getElementById('oral-score-display')
        };

        let timerInterval, recordingInterval, activeTasks = [], sessionStats = { correct: 0, total: 0 }, activeSubjectKey = '', currentOralScore = 0;

        // --- INIT ---
        function init() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                userProgress = JSON.parse(saved);
                checkStreak();
            } else {
                saveState(); // Init fresh
            }
            
            renderDashboardContent();
            updateDashboardStats();
        }

        function checkStreak() {
            const today = new Date().toDateString();
            if (userProgress.lastLogin !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (userProgress.lastLogin === yesterday.toDateString()) {
                    userProgress.streak++;
                } else {
                    userProgress.streak = 1; 
                }
                userProgress.lastLogin = today;
                saveState();
            }
        }
        function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(userProgress)); }
        
        function resetAllData() {
            if(confirm("Czy na pewno chcesz zresetowaƒá wszystkie postƒôpy?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function renderDashboardContent() {
            const grid = dom.contentGrid;
            grid.innerHTML = ''; 

            // 1. Add Oral Exam Card (Static)
            grid.innerHTML += `
                <div data-type="oral" onclick="startOralExam()" class="bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-slate-800 dark:to-slate-800 p-5 rounded-2xl border border-indigo-100 dark:border-slate-700 hover:border-indigo-400 cursor-pointer group relative overflow-hidden dash-card grid-item">
                    <div class="absolute right-0 top-0 p-3 opacity-10 text-6xl group-hover:scale-110 transition-transform">üéôÔ∏è</div>
                    <span class="bg-indigo-600 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Symulator</span>
                    <h3 class="font-bold text-slate-800 dark:text-white text-lg mt-2">Matura Ustna</h3>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Samoocena wg klucza CKE.</p>
                </div>
            `;

            // 2. Generate Cards for ALL subjects in CKE_DATA
            Object.keys(CKE_DATA).forEach(key => {
                if (key === 'oral_makbet') return; // Skip oral data config
                const item = CKE_DATA[key];
                
                // Color mapping
                const colorMap = { red: 'red', blue: 'blue', green: 'green', yellow: 'yellow', indigo: 'indigo', teal: 'teal' };
                const c = colorMap[item.theme] || 'slate';

                const cardHtml = `
                    <div data-type="sheet" onclick="loadSheet('${item.id}')" class="bg-white dark:bg-dark-card p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-dark-border hover:border-${c}-400 transition-all text-left group relative overflow-hidden dash-card grid-item cursor-pointer">
                        <div class="absolute right-0 top-0 p-4 opacity-10 dark:opacity-5 text-6xl group-hover:scale-110 transition-transform">${item.icon}</div>
                        <div class="relative z-10">
                            <h3 class="font-bold text-slate-800 dark:text-white text-lg">${item.subject}</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">${item.desc}</p>
                            <div class="mt-4 flex items-center gap-2">
                                <span class="text-[10px] font-bold text-${c}-600 bg-${c}-50 dark:bg-${c}-900/30 dark:text-${c}-300 px-2 py-1 rounded">${item.label}</span>
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += cardHtml;
            });
        }

        function updateDashboardStats() {
            const avg = userProgress.sheetsCount > 0 ? Math.round(userProgress.totalScoreSum / userProgress.sheetsCount) : 0;
            dom.statAvg.textContent = `${avg}%`;
            dom.statStreak.textContent = userProgress.streak;
            
            // Adaptive Logic
            let worst = null, min = 101;
            if(!userProgress.scoresBySubject) userProgress.scoresBySubject = {};
            if(!userProgress.attemptsBySubject) userProgress.attemptsBySubject = {};

            for (const [k, v] of Object.entries(userProgress.scoresBySubject)) {
                if (userProgress.attemptsBySubject[k] > 0) {
                    const s = v / userProgress.attemptsBySubject[k];
                    if (s < min) { min = s; worst = k; }
                }
            }
            
            if(worst && CKE_DATA[worst]) {
                dom.adaptTitle.textContent = `${CKE_DATA[worst].subject}: Powt√≥rka`;
                dom.adaptDesc.textContent = `≈örednia: ${Math.round(min)}%. Trenuj ten dzia≈Ç.`;
                dom.adaptBtn.setAttribute('onclick', `loadSheet('${worst}')`);
                dom.adaptBtn.textContent = "Trenuj";
            } else {
                dom.adaptTitle.textContent = "Rozpocznij naukƒô";
                dom.adaptDesc.textContent = "Wybierz arkusz, by zebraƒá dane.";
                dom.adaptBtn.textContent = "Start";
            }
        }

        function filterContent(type) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.className = "px-4 py-2 bg-white dark:bg-dark-card text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-dark-border rounded-full text-sm font-medium hover:bg-slate-50 transition-colors tab-btn");
            document.getElementById(`tab-${type}`).className = "px-4 py-2 bg-slate-800 dark:bg-white text-white dark:text-slate-900 rounded-full text-sm font-bold shadow-md transition-colors tab-btn";
            document.querySelectorAll('.grid-item').forEach(item => {
                if (type === 'all') item.classList.remove('hidden');
                else {
                    if (item.dataset.type === type) item.classList.remove('hidden');
                    else item.classList.add('hidden');
                }
            });
        }

        // --- SHEET LOGIC ---
        function loadSheet(key) {
            const data = CKE_DATA[key];
            if (!data) return;
            activeSubjectKey = key;
            dom.home.classList.add('hidden');
            dom.sheet.classList.remove('hidden'); // This now toggles the 'fixed' container
            dom.sheetTitle.textContent = data.title;
            dom.sheetTag.textContent = data.subject;
            dom.sheetTag.className = `shrink-0 px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-${data.theme}-100 text-${data.theme}-700`;
            dom.sourceContent.innerHTML = data.source;
            activeTasks = data.tasks;
            sessionStats = { correct: 0, total: data.tasks.length };
            renderQuestions(data.tasks, data.theme);
            startTimer();
            if(window.MathJax) window.MathJax.typeset();
        }

        function renderQuestions(tasks, theme) {
            dom.questionsList.innerHTML = '';
            tasks.forEach((task, idx) => {
                const el = document.createElement('div');
                el.className = "bg-white dark:bg-dark-bg p-5 rounded-xl border border-slate-200 dark:border-dark-border shadow-sm fade-in mb-4";
                let html = `<h4 class="font-bold text-slate-800 dark:text-white mb-3 text-sm">${task.question}</h4><div class="space-y-2 mb-2" id="options-${task.id}">`;
                task.options.forEach((opt, optIdx) => {
                    html += `<button onclick="checkAnswer(${task.id}, ${optIdx}, ${task.correct})" class="option-btn w-full text-left p-3 border border-slate-200 dark:border-slate-700 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">${opt}</button>`;
                });
                html += `</div><div id="explanation-${task.id}" class="hidden mt-3 pt-3 border-t border-slate-100 dark:border-slate-700 text-sm text-slate-600 dark:text-slate-400"><span class="font-bold">Wyja≈õnienie:</span> ${task.explanation}</div>`;
                el.innerHTML = html;
                dom.questionsList.appendChild(el);
            });
            dom.progress.textContent = `0/${tasks.length}`;
        }

        function checkAnswer(id, selected, correct) {
            const btns = document.getElementById(`options-${id}`).querySelectorAll('button');
            if (btns[0].disabled) return;
            btns.forEach((btn, idx) => {
                btn.disabled = true;
                if (idx === correct) btn.className = "w-full text-left p-3 border border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 rounded-lg text-sm font-bold";
                else if (idx === selected) btn.className = "w-full text-left p-3 border border-red-500 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 rounded-lg text-sm";
                else btn.className += " opacity-50";
            });
            if (selected === correct) sessionStats.correct++;
            document.getElementById(`explanation-${id}`).classList.remove('hidden');
            dom.progress.textContent = `${document.querySelectorAll('[id^=explanation]:not(.hidden)').length}/${activeTasks.length}`;
        }

        function finishSheet() {
            stopTimer();
            const percent = Math.round((sessionStats.correct / sessionStats.total) * 100) || 0;
            userProgress.totalScoreSum += percent;
            userProgress.sheetsCount++;
            
            if(!userProgress.scoresBySubject) userProgress.scoresBySubject = {};
            if(!userProgress.attemptsBySubject) userProgress.attemptsBySubject = {};
            
            if (activeSubjectKey) {
                userProgress.scoresBySubject[activeSubjectKey] = (userProgress.scoresBySubject[activeSubjectKey] || 0) + percent;
                userProgress.attemptsBySubject[activeSubjectKey] = (userProgress.attemptsBySubject[activeSubjectKey] || 0) + 1;
            }
            saveState();
            dom.finalScore.textContent = `${sessionStats.correct}/${sessionStats.total}`;
            dom.finalTime.textContent = dom.timer.textContent;
            dom.summaryModal.classList.remove('hidden');
        }

        // --- ORAL EXAM LOGIC ---
        function startOralExam() {
            dom.home.classList.add('hidden');
            dom.oral.classList.remove('hidden');
            document.getElementById('oral-phase-1').classList.remove('hidden');
            document.getElementById('oral-phase-2').classList.add('hidden');
            document.getElementById('oral-phase-3').classList.add('hidden');
            document.getElementById('recording-ui').classList.remove('hidden');
            document.getElementById('rec-status').textContent = "Naci≈õnij, aby rozpoczƒÖƒá";
            document.getElementById('rec-timer').classList.add('hidden');
            document.getElementById('wave-container').classList.add('hidden');
            isRecording = false;
        }

        let isRecording = false;
        function toggleRecording() {
            const status = document.getElementById('rec-status');
            const timer = document.getElementById('rec-timer');
            const wave = document.getElementById('wave-container');
            if(!isRecording) {
                isRecording = true;
                status.textContent = "Nagrywanie... (Kliknij, aby zako≈Ñczyƒá)";
                status.classList.add('text-red-500', 'animate-pulse');
                timer.classList.remove('hidden');
                wave.classList.remove('hidden');
                let s = 0;
                recordingInterval = setInterval(() => { s++; timer.textContent = `${s}s`; }, 1000);
            } else {
                isRecording = false;
                clearInterval(recordingInterval);
                status.textContent = "Przetwarzanie...";
                status.classList.remove('text-red-500', 'animate-pulse');
                wave.classList.add('hidden');
                document.getElementById('oral-phase-1').classList.add('hidden');
                document.getElementById('oral-phase-2').classList.remove('hidden');
                setTimeout(() => { showChecklist(); }, 2000);
            }
        }

        function showChecklist() {
            document.getElementById('oral-phase-2').classList.add('hidden');
            document.getElementById('oral-phase-3').classList.remove('hidden');
            const data = CKE_DATA['oral_makbet'];
            dom.oralChecklist.innerHTML = '';
            data.criteria.forEach((crit, idx) => {
                const div = document.createElement('div');
                div.className = "flex items-start gap-3 p-3 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors";
                div.onclick = () => { const cb = div.querySelector('input'); cb.checked = !cb.checked; updateOralScore(); };
                div.innerHTML = `<input type="checkbox" id="crit-${idx}" class="mt-1 w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500" onclick="event.stopPropagation(); updateOralScore()"><label for="crit-${idx}" class="text-sm text-slate-700 dark:text-slate-300 cursor-pointer select-none">${crit}</label>`;
                dom.oralChecklist.appendChild(div);
            });
            updateOralScore();
        }

        function updateOralScore() {
            const total = CKE_DATA['oral_makbet'].criteria.length;
            const checked = dom.oralChecklist.querySelectorAll('input:checked').length;
            const percent = Math.round((checked / total) * 100);
            currentOralScore = percent;
            dom.oralScoreDisplay.textContent = `${percent}%`;
            const display = dom.oralScoreDisplay;
            if(percent < 30) display.className = "text-3xl font-black text-red-600";
            else if(percent < 70) display.className = "text-3xl font-black text-yellow-600";
            else display.className = "text-3xl font-black text-green-600";
        }

        function finishOral() {
            userProgress.sheetsCount++;
            userProgress.totalScoreSum += currentOralScore;
            
            if(!userProgress.scoresBySubject) userProgress.scoresBySubject = {};
            if(!userProgress.attemptsBySubject) userProgress.attemptsBySubject = {};
            
            userProgress.scoresBySubject['polski'] = (userProgress.scoresBySubject['polski'] || 0) + currentOralScore;
            userProgress.attemptsBySubject['polski'] = (userProgress.attemptsBySubject['polski'] || 0) + 1;
            userProgress.streak++; 
            saveState();
            goHome();
        }

        // --- UTILS ---
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            document.getElementById('theme-icon').textContent = document.documentElement.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
        }
        function openExitModal() { dom.exitModal.classList.remove('hidden'); }
        function closeExitModal() { dom.exitModal.classList.add('hidden'); }
        function confirmExitAction() { closeExitModal(); goHome(); }
        function closeSummary() { dom.summaryModal.classList.add('hidden'); goHome(); }
        function goHome() {
            dom.sheet.classList.add('hidden');
            dom.oral.classList.add('hidden');
            dom.home.classList.remove('hidden');
            stopTimer();
            updateDashboardStats();
        }
        function toggleAiChat() { dom.aiModal.classList.toggle('hidden'); }
        function startTimer() {
            let s = 0;
            if(timerInterval) clearInterval(timerInterval);
            dom.timer.textContent = "00:00";
            timerInterval = setInterval(() => { s++; dom.timer.textContent = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); }

        init();
    </script>
</body>
</html>
